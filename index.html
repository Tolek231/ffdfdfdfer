<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WandLead — Дашборд</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root{
      --bg:#0b0b0f; --card:#12121a; --muted:#a1a1aa; --text:#f5f7ff; --ring:#1f1f2a;
      --teal:#2bb3c1; --green:#22c55e; --sky:#38bdf8; --red:#ef4444;
      --shadow:0 10px 30px rgba(0,0,0,.35); --radius:18px;
      /* перламутровые оттенки */
      --logo-a:#c6b8ff; --logo-b:#88d9ff; --logo-c:#b8ffe4;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);
         font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:1100px;margin:28px auto;padding:0 16px}

    /* ----- header ----- */
    .top{
      display:grid;
      grid-template-columns:1fr auto 1fr;
      align-items:center;
    }
    .logo{
      justify-self:center;
      font-weight:900;
      font-size:36px;
      letter-spacing:.2px;
      background: conic-gradient(from 200deg,var(--logo-a),var(--logo-b),var(--logo-c),var(--logo-a));
      -webkit-background-clip:text; background-clip:text;
      -webkit-text-fill-color:transparent; text-fill-color:transparent;
      filter: drop-shadow(0 2px 10px rgba(136,217,255,.25));
      animation: shimmer 6s linear infinite;
    }
    @keyframes shimmer{
      0%{filter: drop-shadow(0 2px 10px rgba(136,217,255,.25))}
      50%{filter: drop-shadow(0 2px 16px rgba(184,255,228,.35))}
      100%{filter: drop-shadow(0 2px 10px rgba(136,217,255,.25))}
    }
    .wand{
      justify-self:end; width:42px; height:42px; position:relative;
      filter: drop-shadow(0 0 10px rgba(136,217,255,.35));
      animation:pulse 3s ease-in-out infinite;
    }
    @keyframes pulse{0%,100%{transform:translateY(0) rotate(-10deg)}50%{transform:translateY(-3px) rotate(-6deg)}}
    .spark{position:absolute; inset:-6px; pointer-events:none;
      background: radial-gradient(12px 12px at 80% 25%, rgba(255,255,255,.35), transparent 60%),
                  radial-gradient(10px 10px at 65% 10%, rgba(168,220,255,.25), transparent 60%);
      animation: twinkle 2.6s ease-in-out infinite;}
    @keyframes twinkle{0%,100%{opacity:.3}50%{opacity:.8}}

    /* ----- подзаголовок "Статистика ниже:" ----- */
    .sub{
      margin:14px auto 18px;
      display:flex; flex-direction:column; align-items:center; gap:8px;
      text-align:center;
    }
    .sub .pill{
      padding:8px 14px; border-radius:999px; font-weight:700;
      background: linear-gradient(90deg,var(--logo-a),var(--logo-b),var(--logo-c));
      color:#0b1020;  /* тёмный текст для контраста */
      box-shadow:0 8px 26px rgba(136,217,255,.18), inset 0 1px 0 rgba(255,255,255,.35);
    }
    .sub .line{
      width:min(320px,60%); height:2px; border-radius:2px;
      background: linear-gradient(90deg, transparent, rgba(136,217,255,.55), transparent);
      filter: blur(.2px);
    }

    /* ----- карточки и сетки ----- */
    .card{background:var(--card);border:1px solid var(--ring);border-radius:var(--radius);
          box-shadow:var(--shadow);padding:16px}
    .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:14px}
    .kpi{background:var(--card);border:1px solid var(--ring);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow)}
    .kpi .label{font-size:12px;color:var(--muted);margin-bottom:6px}
    .kpi .value{font-size:26px;font-weight:800}

    .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:14px;margin-top:16px}
    .metric{ text-align:center; position:relative; overflow:hidden }
    .metric h4{margin:0 0 6px;color:var(--muted);font-weight:600}
    .metric .value{font-size:20px;font-weight:800;margin-bottom:6px}
    canvas{max-width:230px;margin:0 auto}
    .legend{display:flex;gap:10px;justify-content:center;margin-top:6px;color:var(--muted);font-size:12px}
    .dot{width:8px;height:8px;border-radius:50%}
    .glow:before{
      content:""; position:absolute; inset:-40%;
      background: radial-gradient(circle at 50% 30%, rgba(109,92,255,.12), transparent 60%);
      filter: blur(28px);
    }
    .footer{margin-top:14px;color:var(--muted);font-size:12px}
  </style>
</head>
<body>
<div class="wrap">
  <!-- HEADER -->
  <div class="top">
    <div></div>
    <div class="logo">WandLead</div>
    <div class="wand">
      <!-- SVG палочка -->
      <svg viewBox="0 0 64 64" width="42" height="42">
        <defs>
          <linearGradient id="g1" x1="0" x2="1">
            <stop offset="0%"  stop-color="var(--logo-a)"/>
            <stop offset="50%" stop-color="var(--logo-b)"/>
            <stop offset="100%" stop-color="var(--logo-c)"/>
          </linearGradient>
        </defs>
        <circle cx="46" cy="8" r="2.3" fill="url(#g1)"/>
        <circle cx="55" cy="18" r="1.6" fill="url(#g1)"/>
        <circle cx="50" cy="28" r="1.9" fill="url(#g1)"/>
        <rect x="8" y="44" width="32" height="4" rx="2" fill="url(#g1)" transform="rotate(-30 8 44)"/>
        <rect x="35" y="20" width="6" height="6" rx="1.5" fill="url(#g1)"/>
      </svg>
      <span class="spark"></span>
    </div>
  </div>

  <!-- SUBTITLE -->
  <div class="sub">
    <div class="pill">Статистика ниже:</div>
    <div class="line"></div>
  </div>

  <!-- CONTENT -->
  <div class="card">
    <!-- KPI (без графиков) -->
    <div class="kpis">
      <div class="kpi">
        <div class="label">Отправлено</div>
        <div class="value" id="sentKpi">—</div>
      </div>
      <div class="kpi">
        <div class="label">Доставлено</div>
        <div class="value" id="deliveredKpi">—</div>
      </div>
    </div>

    <!-- Метрики с графиками -->
    <div class="stats">
      <div class="metric card glow">
        <h4>открытия</h4>
        <div class="value" id="opensVal">—</div>
        <canvas id="opensChart" width="240" height="240"></canvas>
        <div class="legend"><span class="dot" style="background:var(--teal)"></span>от доставлено</div>
      </div>

      <div class="metric card glow">
        <h4>переходы</h4>
        <div class="value" id="clicksVal">—</div>
        <canvas id="clicksChart" width="240" height="240"></canvas>
        <div class="legend"><span class="dot" style="background:var(--green)"></span>от открытий (CTOR)</div>
      </div>

      <div class="metric card glow">
        <h4>отписались</h4>
        <div class="value" id="unsubsVal">—</div>
        <canvas id="unsubsChart" width="240" height="240"></canvas>
        <div class="legend"><span class="dot" style="background:var(--sky)"></span>от доставлено</div>
      </div>

      <div class="metric card glow">
        <h4>ошибки</h4>
        <div class="value" id="errorsVal">—</div>
        <canvas id="errorsChart" width="240" height="240"></canvas>
        <div class="legend"><span class="dot" style="background:var(--red)"></span>от отправлено</div>
      </div>
    </div>

    <div class="footer" id="updatedInfo">Обновление: —</div>
  </div>
</div>

<script>
  const tg = window.Telegram?.WebApp; if (tg) tg.expand();

  // Проценты в центре пончика с лёгким свечением
  const centerText = {
    id:'centerText',
    afterDraw(chart, args, opts){
      const {ctx, chartArea:{width,height}} = chart;
      if(!opts?.text) return;
      ctx.save();
      ctx.font = opts.font || '700 28px Inter, system-ui';
      ctx.fillStyle = opts.color || '#f7fbff';
      ctx.textAlign='center'; ctx.textBaseline='middle';
      ctx.shadowColor='rgba(168,220,255,.35)';
      ctx.shadowBlur=12;
      ctx.fillText(opts.text, width/2, height/2);
      ctx.restore();
    }
  };
  Chart.register(centerText);

  const fmtNum = n => n==null ? '—' : (n>=1000 ? (Math.round(n/10)/100).toLocaleString('ru-RU')+'K' : n.toLocaleString('ru-RU'));
  const clampPct = v => Math.max(0, Math.min(100, v));

  function makeGradient(ctx, key){
    const g = ctx.createLinearGradient(0,0,230,230);
    const map = {
      teal:['#2bb3c1','#79e3ef','#2bb3c1'],
      green:['#22c55e','#8cf0b7','#22c55e'],
      sky:['#38bdf8','#a8e6ff','#38bdf8'],
      red:['#ef4444','#ff9b9b','#ef4444']
    };
    const p = map[key] || ['#6d5cff','#b9b0ff','#6d5cff'];
    g.addColorStop(0,p[0]); g.addColorStop(.5,p[1]); g.addColorStop(1,p[2]);
    return g;
  }

  function donut(id, percent, paletteKey){
    const el = document.getElementById(id);
    const ex = Chart.getChart(el); if (ex) ex.destroy();
    const ctx = el.getContext('2d');
    const grad = makeGradient(ctx, paletteKey);

    return new Chart(el, {
      type:'doughnut',
      data:{
        labels:['val','rest'],
        datasets:[{
          data:[clampPct(percent), 100-clampPct(percent)],
          borderWidth:0, hoverOffset:0, cutout:'70%',
          backgroundColor:[grad, '#1f1f2a']
        }]
      },
      options:{
        animation:{
          duration:1200, easing:'easeOutQuart',
          animateRotate:true, animateScale:true
        },
        plugins:{ legend:{display:false}, tooltip:{enabled:false}, centerText:{ text: percent.toFixed(1)+'%' } }
      },
      plugins:[{
        id:'glow',
        beforeDraw(c){
          const {ctx, chartArea:{width,height}} = c;
          ctx.save();
          ctx.shadowColor='rgba(109,92,255,.22)';
          ctx.shadowBlur=14;
          ctx.beginPath(); ctx.arc(width/2,height/2,Math.min(width,height)/2.35,0,Math.PI*2);
          ctx.strokeStyle='rgba(109,92,255,.18)'; ctx.lineWidth=2; ctx.stroke();
          ctx.restore();
        }
      }]
    });
  }

  function parseTxt(txt){
    const out = {};
    txt.split(/\r?\n/).forEach(line=>{
      const m = line.trim().match(/^(\w+)\s*=\s*(.+)$/);
      if(m){ out[m[1]] = isNaN(+m[2]) ? m[2] : Number(m[2]); }
    });
    if(out.errors == null && out.sent != null && out.delivered != null){
      out.errors = Math.max(0, out.sent - out.delivered);
    }
    return out;
  }

  async function loadData(){
    const res = await fetch('data.txt', { cache:'no-store' });
    if(!res.ok) throw new Error('Не удалось загрузить data.txt');
    return parseTxt(await res.text());
  }

  let timer;
  async function render(){
    try{
      const d = await loadData();

      const sent = +d.sent || 0;
      const delivered = +d.delivered || 0;
      const opens = +d.opens || 0;
      const clicks = +d.clicks || 0;
      const unsubs = +d.unsubs || 0;
      const errors = +d.errors || 0;

      // KPI (без графиков)
      document.getElementById('sentKpi').textContent = fmtNum(sent);
      document.getElementById('deliveredKpi').textContent = fmtNum(delivered);

      // подписи под графиками
      document.getElementById('opensVal').textContent = fmtNum(opens);
      document.getElementById('clicksVal').textContent = fmtNum(clicks);
      document.getElementById('unsubsVal').textContent = fmtNum(unsubs);
      document.getElementById('errorsVal').textContent = fmtNum(errors);

      // проценты
      const pOpens  = delivered ? (opens/delivered)*100 : 0;
      const pClicks = opens ? (clicks/opens)*100 : 0;     // CTOR
      const pUnsubs = delivered ? (unsubs/delivered)*100 : 0;
      const pErrors = sent ? (errors/sent)*100 : 0;

      donut('opensChart',  pOpens,  'teal');
      donut('clicksChart', pClicks, 'green');
      donut('unsubsChart', pUnsubs, 'sky');
      donut('errorsChart', pErrors, 'red');

      const upd = d.updated ? new Date(d.updated) : new Date();
      document.getElementById('updatedInfo').textContent =
        'Обновление: ' + upd.toLocaleString('ru-RU');
    }catch(e){
      document.getElementById('updatedInfo').textContent = 'Ошибка загрузки data.txt';
      console.error(e);
    }finally{
      clearTimeout(timer);
      timer = setTimeout(render, 30000);
    }
  }
  render();
</script>
</body>
</html>

