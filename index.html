<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <title>WandLead — Личный кабинет клиента</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      :root { color-scheme: dark; }
      body { background:#0b0b0f; }
      .card { background:rgba(255,255,255,.05); backdrop-filter:blur(6px); border-radius:16px; }
      .btn { background:#1f2937; border:1px solid rgba(255,255,255,.08); padding:.4rem .8rem; border-radius:.7rem; }
      .btn:hover { background:#273244; }
      .muted { color:rgba(255,255,255,.65) }
      .badge { background:rgba(255,255,255,.08); padding:.25rem .5rem; border-radius:.5rem; font-size:.75rem }
      .i-btn { width:22px; height:22px; display:inline-flex; align-items:center; justify-content:center; border-radius:999px; background:rgba(255,255,255,.08); font-weight:700 }
      dialog::backdrop { background:rgba(0,0,0,.6) }
      dialog { border:none; border-radius:16px; padding:0; width:min(900px,96vw); background:#0f1117; color:white }
    </style>

    <!-- React + ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Recharts (включая Funnel) -->
    <script src="https://unpkg.com/recharts/umd/Recharts.min.js"></script>
  </head>
  <body class="min-h-screen">
    <div id="root" class="max-w-7xl mx-auto p-6"></div>

    <script>
      const {useState,useEffect,useMemo} = React;
      const {
        AreaChart,Area,XAxis,YAxis,CartesianGrid,Tooltip,ResponsiveContainer,Brush,Legend,
        FunnelChart,Funnel,LabelList
      } = Recharts;

      // ---------- Утилиты ----------
      const nf = new Intl.NumberFormat('ru-RU');
      const fmtN = n => (n==null || isNaN(n)) ? '—' : nf.format(n);
      const pct = n => (n==null || isNaN(n)) ? '—' : (n*100).toFixed(1)+'%';
      const lastN = (arr,n)=>arr.slice(Math.max(0,arr.length-n));
      const forecast7 = (series,key)=>{
        if(!series?.length) return 0;
        const l7 = lastN(series,7);
        const sum = l7.reduce((a,d)=>a+(+d[key]||0),0);
        return Math.round(sum/Math.max(l7.length,1)*7);
      };

      // ---------- Простой модал ----------
      function Modal({open,setOpen,title,children}){
        return (
          <dialog open={open} onClose={()=>setOpen(false)}>
            <div class="p-5">
              <div class="flex items-center justify-between mb-3">
                <h3 class="text-lg font-semibold">{title}</h3>
                <button class="btn" onClick={()=>setOpen(false)}>Закрыть</button>
              </div>
              {children}
            </div>
          </dialog>
        )
      }

      function MetricDialog({title,data,keyName,color,help}){
        const [open,setOpen]=useState(false);
        const current = data?.length ? (+data.at(-1)[keyName]||0) : 0;
        const fc = forecast7(data,keyName);
        return (
          <>
            <button class="btn" onClick={()=>setOpen(true)}>Открыть метрику</button>
            <Modal open={open} setOpen={setOpen} title={title}>
              <div class="space-y-4">
                <div class="h-72 w-full">
                  <div style="width:100%;height:100%">
                    <div id={title+"-chart"} style="width:100%;height:100%">
                      <ResponsiveContainer width="100%" height="100%">
                        <AreaChart data={data} margin={{top:10,right:20,left:0,bottom:10}}>
                          <defs>
                            <linearGradient id={"g-"+keyName} x1="0" y1="0" x2="0" y2="1">
                              <stop offset="0%" stop-color={color} stop-opacity="0.35"/>
                              <stop offset="90%" stop-color={color} stop-opacity="0.02"/>
                            </linearGradient>
                          </defs>
                          <CartesianGrid strokeDasharray="3 3" stroke="rgba(255,255,255,.12)"/>
                          <XAxis dataKey="date" tickFormatter={d=>new Date(d).toLocaleDateString('ru-RU')}/>
                          <YAxis allowDecimals={false}/>
                          <Tooltip formatter={v=>fmtN(+v)} labelFormatter={l=>new Date(l).toLocaleDateString('ru-RU')}/>
                          <Area type="monotone" dataKey={keyName} name={title} stroke={color} fill={`url(#g-${keyName})`} strokeWidth={2} dot={false}/>
                          <Brush dataKey="date" height={24}/>
                        </AreaChart>
                      </ResponsiveContainer>
                    </div>
                  </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                  <div class="card p-4">
                    <div class="muted text-sm mb-1">Текущее значение</div>
                    <div class="text-2xl font-semibold">{fmtN(current)}</div>
                  </div>
                  <div class="card p-4">
                    <div class="muted text-sm mb-1">Прогноз на неделю</div>
                    <div class="text-2xl font-semibold">{fmtN(fc)}</div>
                  </div>
                    <div class="card p-4">
                      <div class="muted text-sm mb-1">Описание</div>
                      <div class="text-sm muted">{help}</div>
                    </div>
                </div>
                <div class="muted text-xs">Подсказка: водите мышкой по точкам и выделяйте период бегунком снизу.</div>
              </div>
            </Modal>
          </>
        )
      }

      function MetricCard({title,value,delta,color,help,dialog}){
        const up = typeof delta==='number' ? delta>=0 : null;
        return (
          <div class="card p-4">
            <div class="flex items-center justify-between">
              <div class="muted text-sm flex items-center gap-2">
                {title}
                <span title={help} class="i-btn">i</span>
              </div>
              {delta!=null && (
                <span class={"badge "+(up?"text-emerald-400":"text-rose-400")}>
                  {up?"▲":"▼"} {Math.abs(delta).toFixed(1)}%
                </span>
              )}
            </div>
            <div class="flex items-end justify-between mt-2">
              <div class="text-3xl font-semibold" style={{color}}>{fmtN(value)}</div>
              {dialog}
            </div>
          </div>
        )
      }

      function DynamicsBlock({data}){
        return (
          <div class="card p-4">
            <div class="flex items-center gap-2 mb-2">
              <h3 class="font-semibold">Динамика: Открытия и Ответы</h3>
              <span class="i-btn" title="Показывает суммарные открытия и ответы по периодам. Внизу — бегунок выбора периода.">i</span>
            </div>
            <div style="width:100%;height:320px">
              <ResponsiveContainer width="100%" height="100%">
                <AreaChart data={data} margin={{top:10,right:20,left:0,bottom:10}}>
                  <defs>
                    <linearGradient id="g-opens" x1="0" y1="0" x2="0" y2="1">
                      <stop offset="0%" stop-color="#60a5fa" stop-opacity="0.35"/>
                      <stop offset="90%" stop-color="#60a5fa" stop-opacity="0.02"/>
                    </linearGradient>
                    <linearGradient id="g-replies" x1="0" y1="0" x2="0" y2="1">
                      <stop offset="0%" stop-color="#34d399" stop-opacity="0.35"/>
                      <stop offset="90%" stop-color="#34d399" stop-opacity="0.02"/>
                    </linearGradient>
                  </defs>
                  <CartesianGrid strokeDasharray="3 3" stroke="rgba(255,255,255,.12)"/>
                  <XAxis dataKey="date" tickFormatter={d=>new Date(d).toLocaleDateString('ru-RU')}/>
                  <YAxis allowDecimals={false}/>
                  <Tooltip formatter={v=>fmtN(+v)} labelFormatter={l=>new Date(l).toLocaleDateString('ru-RU')}/>
                  <Legend />
                  <Area type="monotone" dataKey="opens" name="Открытия" stroke="#60a5fa" fill="url(#g-opens)" strokeWidth="2" dot={false}/>
                  <Area type="monotone" dataKey="replies" name="Ответы" stroke="#34d399" fill="url(#g-replies)" strokeWidth="2" dot={false}/>
                  <Brush dataKey="date" height={24}/>
                </AreaChart>
              </ResponsiveContainer>
            </div>
          </div>
        )
      }

      function FunnelBlock({sent,opens,replies}){
        const data = [
          { name:'Отправлено', value: sent },
          { name:'Открыто',   value: opens },
          { name:'Ответы',    value: replies },
        ];
        return (
          <div class="card p-4">
            <div class="flex items-center gap-2 mb-2">
              <h3 class="font-semibold">Воронка взаимодействия</h3>
              <span class="i-btn" title="Этапы: отправлено → открыто → ответ. Значения — суммарно за период.">i</span>
            </div>
            <div style="width:100%;height:280px">
              <ResponsiveContainer width="100%" height="100%">
                <FunnelChart>
                  <Tooltip formatter={v=>fmtN(+v)} />
                  <Funnel dataKey="value" data={data} isAnimationActive>
                    <LabelList dataKey="name" position="left" />
                    <LabelList dataKey="value" position="right" formatter={v=>fmtN(+v)} />
                  </Funnel>
                </FunnelChart>
              </ResponsiveContainer>
            </div>
          </div>
        )
      }

      function DeliveryQuality({delivered,bounces}){
        const total = delivered + bounces;
        const rate = total ? delivered/total : 0;
        return (
          <div class="card p-4">
            <div class="flex items-center gap-2 mb-2">
              <h3 class="font-semibold">Качество доставки</h3>
              <span class="i-btn" title="Доля успешно доставленных писем среди доставленных + ошибок.">i</span>
            </div>
            <div class="text-3xl font-semibold mb-3">{pct(rate)} <span class="muted text-base font-normal">успешных</span></div>
            <div class="grid grid-cols-2 gap-3">
              <div class="card p-3">
                <div class="muted text-sm">Успешно доставлено</div>
                <div class="text-xl font-semibold">{fmtN(delivered)}</div>
              </div>
              <div class="card p-3">
                <div class="muted text-sm">Ошибки доставки</div>
                <div class="text-xl font-semibold">{fmtN(bounces)}</div>
              </div>
            </div>
          </div>
        )
      }

      function Spheres({spheres}){
        const avgOpen = useMemo(()=>{
          if(!spheres?.length) return 0;
          return spheres.reduce((a,s)=>a+(+s.open_rate||0),0)/spheres.length;
        },[spheres]);
        const avgReply = useMemo(()=>{
          if(!spheres?.length) return 0;
          return spheres.reduce((a,s)=>a+(+s.reply_rate||0),0)/spheres.length;
        },[spheres]);

        return (
          <div class="space-y-3">
            <div class="muted text-sm">Сравнение со средними по аккаунту: open {pct(avgOpen)}, reply {pct(avgReply)}.</div>
            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
              {spheres.map(s=>{
                const openDelta = (+s.open_rate||0) - avgOpen;
                const replyDelta = (+s.reply_rate||0) - avgReply;
                return (
                  <div class="card p-4" key={s.name}>
                    <div class="flex items-center justify-between mb-2">
                      <div class="font-semibold">{s.name}</div>
                      <div class="muted text-sm">Отправлено: {fmtN(+s.sent||0)}</div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                      <div class="card p-3">
                        <div class="muted text-xs">Открытия</div>
                        <div class="text-xl font-semibold">{pct(+s.open_rate||0)}</div>
                        <div class={(openDelta>=0?'text-emerald-400':'text-rose-400')+' text-sm mt-1'}>
                          {openDelta>=0?'▲':'▼'} {Math.abs(openDelta*100).toFixed(1)}%
                        </div>
                      </div>
                      <div class="card p-3">
                        <div class="muted text-xs">Ответы</div>
                        <div class="text-xl font-semibold">{pct(+s.reply_rate||0)}</div>
                        <div class={(replyDelta>=0?'text-emerald-400':'text-rose-400')+' text-sm mt-1'}>
                          {replyDelta>=0?'▲':'▼'} {Math.abs(replyDelta*100).toFixed(1)}%
                        </div>
                      </div>
                    </div>
                  </div>
                )
              })}
            </div>
          </div>
        )
      }

      function Tabs({tab,setTab}){
        return (
          <div class="inline-flex gap-2 bg-[rgba(255,255,255,.06)] p-1 rounded-xl">
            <button class={"btn "+(tab==='overview'?'ring-2 ring-white/20':'')} onClick={()=>setTab('overview')}>Обзор</button>
            <button class={"btn "+(tab==='spheres'?'ring-2 ring-white/20':'')} onClick={()=>setTab('spheres')}>Сферы</button>
          </div>
        )
      }

      function App(){
        const [tab,setTab]=useState('overview');
        const [data,setData]=useState(null);
        const [err,setErr]=useState(null);

        useEffect(()=>{
          fetch('data.txt').then(r=>{
            if(!r.ok) throw new Error('Не найден data.txt');
            return r.text();
          }).then(t=>{
            try { setData(JSON.parse(t)); }
            catch(e){ throw new Error('Некорректный JSON в data.txt'); }
          }).catch(e=>setErr(e.message||'Ошибка загрузки'));
        },[]);

        if(err) return <div class="text-red-400">Ошибка: {err}</div>;
        if(!data) return <div class="muted">Загрузка данных…</div>;

        const timeline = data.timeline || [];
        const totals = {
          sent: timeline.reduce((a,d)=>a+(+d.sent||0),0),
          delivered: timeline.reduce((a,d)=>a+(+d.delivered||0),0),
          opens: timeline.reduce((a,d)=>a+(+d.opens||0),0),
          replies: timeline.reduce((a,d)=>a+(+d.replies||0),0),
          lpr_replies: timeline.reduce((a,d)=>a+(+d.lpr_replies||0),0),
          bounces: timeline.reduce((a,d)=>a+(+d.bounces||0),0),
        };
        const last = timeline.at(-1) || {};
        const last7 = lastN(timeline,7);
        const delta = k=>{
          if(last7.length<2) return 0;
          const prev = +last7[0][k]||0, curr = +last7.at(-1)[k]||0;
          return prev===0 ? 0 : ( (curr-prev)/Math.max(prev,1) )*100;
        };

        return (
          <div>
            <header class="flex items-center justify-between">
              <div>
                <h1 class="text-2xl font-semibold">WandLead — Личный кабинет</h1>
                <div class="muted text-sm">Все метрики подгружаются из <code>data.txt</code>.</div>
              </div>
              <Tabs tab={tab} setTab={setTab}/>
            </header>

            {tab==='overview' && (
              <div class="space-y-6 mt-6">
                <!-- четыре метрики -->
                <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4">
                  <MetricCard
                    title="Отправлено писем"
                    value={+last.sent||0}
                    delta={delta('sent')}
                    color="#a78bfa"
                    help="Сколько писем отправлено за день. Нажмите, чтобы открыть подробный график."
                    dialog={<MetricDialog title="Отправлено" data={timeline} keyName="sent" color="#a78bfa" help="Количество отправленных писем по дням. Внизу — выбор периода."/>}
                  />
                  <MetricCard
                    title="Доставлено"
                    value={+last.delivered||0}
                    delta={delta('delivered')}
                    color="#60a5fa"
                    help="Сообщения, принятые сервером получателя."
                    dialog={<MetricDialog title="Доставлено" data={timeline} keyName="delivered" color="#60a5fa" help="Успешно доставленные письма по дням."/>}
                  />
                  <MetricCard
                    title="Ответы от ЛПР"
                    value={+last.lpr_replies||0}
                    delta={delta('lpr_replies')}
                    color="#34d399"
                    help="Ответы именно от лиц, принимающих решения."
                    dialog={<MetricDialog title="Ответы от ЛПР" data={timeline} keyName="lpr_replies" color="#34d399" help="Считаем только ответы, классифицированные как ЛПР."/>}
                  />
                  <MetricCard
                    title="Ошибки доставки"
                    value={+last.bounces||0}
                    delta={delta('bounces')}
                    color="#f87171"
                    help="Hard/soft bounces — ошибки доставки."
                    dialog={<MetricDialog title="Ошибки доставки" data={timeline} keyName="bounces" color="#f87171" help="Ошибки доставки по дням."/>}
                  />
                </div>

                <DynamicsBlock data={timeline}/>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                  <FunnelBlock sent={totals.sent} opens={totals.opens} replies={totals.replies}/>
                  <DeliveryQuality delivered={totals.delivered} bounces={totals.bounces}/>
                </div>
              </div>
            )}

            {tab==='spheres' && (
              <div class="mt-6">
                <Spheres spheres={data.spheres||[]}/>
              </div>
            )}

            <footer class="mt-10 text-center muted text-xs">
              Обновляйте <code>data.txt</code> — графики и метрики подтянутся автоматически.
            </footer>
          </div>
        )
      }

      ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(App));
    </script>
  </body>
</html>
