<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Личный кабинет — Рассылки</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
  :root{
    --bg: #0b0e12;
    --panel: #11151b;
    --panel-2: #0e1318;
    --text: #eaedf3;
    --muted: #9aa3b2;
    --accent: #6ea8fe;
    --accent-2: #8b5cf6;
    --good:#2ecc71;
    --bad:#ff6b6b;
    --ring: rgba(110,168,254,.45);
    --card-radius: 16px;
    --shadow: 0 10px 35px rgba(0,0,0,.35);
    --border: 1px solid rgba(255,255,255,.06);
  }
  *{box-sizing:border-box;}
  html,body{height:100%}
  body{
    margin:0;
    font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;
    color:var(--text);
    background: radial-gradient(1000px 600px at 20% -10%, rgba(110,168,254,.12), transparent),
               radial-gradient(1000px 600px at 80% -10%, rgba(139,92,246,.10), transparent),
               var(--bg);
  }
  header{
    position:sticky; top:0; z-index:10;
    backdrop-filter: blur(6px);
    background:linear-gradient(to bottom, rgba(11,14,18,.9), rgba(11,14,18,.5), transparent);
    padding:16px 20px 8px;
    border-bottom: 1px solid rgba(255,255,255,.06);
  }
  .wrap{max-width:1200px;margin:0 auto;padding:12px 20px 64px;}
  .brand{display:flex;align-items:center;gap:12px;font-weight:800;letter-spacing:.2px}
  .brand .dot{width:10px;height:10px;border-radius:999px;background:linear-gradient(135deg,var(--accent),var(--accent-2)); box-shadow:0 0 0 6px rgba(110,168,254,.15);}
  nav{margin-top:10px;display:flex;gap:8px}
  .tab{padding:10px 14px;border-radius:10px;background:var(--panel);border:var(--border);color:var(--muted);cursor:pointer;transition:.2s}
  .tab.active{color:var(--text);background:linear-gradient(180deg,#151a21,#0f1318);box-shadow:var(--shadow)}
  .grid{display:grid;gap:16px;grid-template-columns:repeat(12,1fr)}
  .card{grid-column: span 6; background:linear-gradient(180deg,#141922,#0e1218); border:var(--border); border-radius:var(--card-radius); box-shadow:var(--shadow); padding:16px; position:relative; overflow:hidden}
  .card:hover{outline:1px solid var(--ring)}
  .card.small{grid-column: span 3;}
  .card.full{grid-column: span 12;}
  .card h3{margin:0 0 8px;font-size:16px;font-weight:700;display:flex;align-items:center;gap:8px}
  .kpi{display:flex;align-items:baseline;gap:10px;margin-top:6px}
  .kpi .big{font-size:32px;font-weight:800}
  .muted{color:var(--muted);font-size:12px}
  .btn{background:linear-gradient(180deg,#1d2430,#121720);border:var(--border);padding:8px 10px;border-radius:10px;color:var(--text);cursor:pointer}
  .row{display:flex;align-items:center;justify-content:space-between;gap:10px}
  .chart-box{height:260px;position:relative;}
.chart-box canvas{width:100%!important;height:100%!important;}
  .clickable{cursor:pointer}
  /* info icon */
  .info{width:18px;height:18px;border-radius:999px;background:linear-gradient(135deg,#293244,#151b26);border:var(--border);display:inline-grid;place-items:center;font-size:12px;color:#aeb7c6}
  .info:hover{box-shadow:0 0 0 6px rgba(110,168,254,.08);color:var(--text)}
  /* modal */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(5,8,12,.7);z-index:50}
  .modal.open{display:flex}
  .modal .box{width:min(920px,92vw);background:linear-gradient(180deg,#161b24,#10151c);border:var(--border);border-radius:18px;box-shadow:var(--shadow);padding:20px;position:relative}
  .modal .close{position:absolute;right:14px;top:14px;background:#1b212c;border:var(--border);border-radius:10px;color:#cbd2df;padding:6px 10px;cursor:pointer}
  .legend{display:flex;gap:14px;align-items:center;flex-wrap:wrap;margin:10px 0 2px}
  .legend .dot{width:10px;height:10px;border-radius:50%}
  .foot-metrics{display:flex;gap:24px;flex-wrap:wrap;margin-top:8px;color:#cbd2df}
  .foot-metrics div{background:#0f141c;border:var(--border);padding:10px 12px;border-radius:10px}
  /* spheres table */
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{padding:12px 10px;border-bottom:1px solid rgba(255,255,255,.06);text-align:left}
  th{color:#cdd6e4;font-weight:600}
  .arrow{display:inline-flex;align-items:center;gap:4px;font-weight:600}
  .arrow.up{color:var(--good)}
  .arrow.down{color:var(--bad)}
  .hidden{display:none}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="row">
      <div class="brand">
        <div class="dot"></div>
        <div>WandLead — Личный кабинет клиента</div>
      </div>
      <div class="muted" id="period"></div>
    </div>
    <nav>
      <div class="tab active" data-tab="overview">Обзор</div>
      <div class="tab" data-tab="sectors">Сферы</div>
    </nav>
  </div>
</header>

<main class="wrap">
  <!-- OVERVIEW -->
  <section id="overview" class="grid">
    <div class="card clickable" data-metric="sent">
      <h3>Отправлено писем <span class="info" data-info="sent">i</span></h3>
      <div class="kpi"><div class="big" id="sent-total">—</div><span class="muted">за период</span></div>
      <div class="chart-box"><canvas id="sent-mini"></canvas></div>
    </div>
    <div class="card clickable" data-metric="delivered">
      <h3>Получено (доставлено) <span class="info" data-info="delivered">i</span></h3>
      <div class="kpi"><div class="big" id="delivered-total">—</div><span class="muted">за период</span></div>
      <div class="chart-box"><canvas id="delivered-mini"></canvas></div>
    </div>
    <div class="card clickable" data-metric="replies">
      <h3>Ответы от ЛПР <span class="info" data-info="replies">i</span></h3>
      <div class="kpi"><div class="big" id="replies-total">—</div><span class="muted">за период</span></div>
      <div class="chart-box"><canvas id="replies-mini"></canvas></div>
    </div>
    <div class="card clickable" data-metric="bounces">
      <h3>Ошибки доставки <span class="info" data-info="bounces">i</span></h3>
      <div class="kpi"><div class="big" id="bounces-total">—</div><span class="muted">за период</span></div>
      <div class="chart-box"><canvas id="bounces-mini"></canvas></div>
    </div>

    <div class="card full">
      <div class="row">
        <h3>Динамика: открытия и ответы <span class="info" data-info="dynamics">i</span></h3>
      </div>
      <div class="chart-box"><canvas id="dynamics"></canvas></div>
    </div>

    <div class="card">
      <h3>Воронка <span class="info" data-info="funnel">i</span></h3>
      <div class="chart-box"><canvas id="funnel"></canvas></div>
    </div>
    <div class="card">
      <h3>Качество доставки <span class="info" data-info="quality">i</span></h3>
      <div class="kpi">
        <div class="big" id="quality-val">—%</div>
        <span class="muted">успешных доставок</span>
      </div>
      <div class="chart-box"><canvas id="quality"></canvas></div>
    </div>
  </section>

  <!-- SECTORS -->
  <section id="sectors" class="hidden">
    <div class="card full">
      <h3>Сферы и их эффективность <span class="info" data-info="sectors">i</span></h3>
      <table id="sectors-table">
        <thead>
          <tr><th>Сфера</th><th>Отправлено</th><th>Открытия</th><th>Ответы</th><th>К открываемости</th><th>К ответам</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
</main>

<!-- MODAL -->
<div class="modal" id="modal">
  <div class="box">
    <button class="close" id="modal-close">Закрыть</button>
    <h2 id="modal-title" style="margin:0 0 6px 0"></h2>
    <div class="muted" id="modal-sub"></div>
    <div style="margin-top:10px"><div class="chart-box"><canvas id="modal-chart" height="340"></canvas></div></div>
    <div class="legend" id="modal-legend"></div>
    <div class="foot-metrics" id="modal-foot"></div>
  </div>
</div>

<script>
const INFO = {
  sent: "Количество исходящих писем, отправленных системой за выбранный период. Прогноз рассчитывается исходя из среднего темпа отправки за последние 7 дней.",
  delivered: "Сколько писем было успешно доставлено получателям. Отличается от «Отправлено» на величину технических ошибок (bounce).",
  replies: "Ответы именно от ЛПР (лиц, принимающих решения). Счёт ведётся по уникальным диалогам.",
  bounces: "Ошибки доставки (hard/soft bounce). Чем ниже — тем лучше.",
  dynamics: "Общий график, где одновременно показаны открытия и ответы за каждый день. Наведите курсором, чтобы увидеть значения.",
  funnel: "Классическая воронка: от отправленных — к открытым — к ответам ЛПР. Значения агрегированы за весь период.",
  quality: "Доля успешно доставленных писем = Доставлено / Отправлено.",
  sectors: "Разбивка по сферам. Зелёная/красная стрелка показывает, насколько метрики сферы выше/ниже средних по вашему периоду."
};

const fmt = new Intl.NumberFormat('ru-RU');
const pct = (v)=> (v*100).toFixed(1)+'%';
let DATA = null;

// Tabs
document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click',()=>{
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  t.classList.add('active');
  document.querySelectorAll('main > section').forEach(s=>s.classList.add('hidden'));
  document.getElementById(t.dataset.tab).classList.remove('hidden');
}));

// Info tooltips (modal mini)
document.querySelectorAll('.info').forEach(i=>i.addEventListener('click', (e)=>{
  const key = i.dataset.info;
  openModal({ title: 'Что означает блок', sub: '', seriesKey: null, infoHTML: `<div class="muted">${INFO[key]}</div>` });
  e.stopPropagation();
}));

// Load external data
fetch('data.txt')
  .then(r=>r.json())
  .then(json=>{
    DATA = json;
    document.getElementById('period').textContent = 'Период: ' + json.period;
    initOverview(json);
    initDynamics(json);
    initFunnel(json);
    initQuality(json);
    initSectors(json);
  })
  .catch(err=>{
    console.error(err);
    alert('Не удалось загрузить data.txt');
  });

// Helpers
function toXY(arr){ return { labels: arr.map(p=>p.date), values: arr.map(p=>p.value) }; }
function sum(arr){ return arr.reduce((a,b)=>a+b,0); }
function avg(arr){ return sum(arr)/arr.length; }
function last(arr){ return arr[arr.length-1]; }
function forecast7(arr){ // weekly forecast at same pace as last 7 days average
  const slice = arr.slice(-7).map(x=>x.value);
  return Math.round(avg(slice)*7);
}
function gradient(ctx, color){
  const g = ctx.createLinearGradient(0,0,0,260);
  g.addColorStop(0, color);
  g.addColorStop(1, 'rgba(0,0,0,0)');
  return g;
}

function sparkline(canvasId, arr, color){
  const {labels, values} = toXY(arr);
  const ctx = document.getElementById(canvasId).getContext('2d');
  const grad = gradient(ctx, 'rgba(110,168,254,.30)');
  return new Chart(ctx,{
    type:'line',
    data:{labels, datasets:[{data:values, tension:.35, fill:true, pointRadius:0, borderWidth:2, borderColor:'rgba(110,168,254,.9)', backgroundColor:grad}]},
    options:{
      responsive:true, maintainAspectRatio:false,
      plugins:{legend:{display:false}, tooltip:{mode:'index', intersect:false}},
      scales:{x:{display:false}, y:{display:false}}
    }
  });
}

function initOverview(d){
  const S = d.series;
  const cards = [
    {key:'sent', name:'Отправлено писем', canvas:'sent-mini'},
    {key:'delivered', name:'Получено (доставлено)', canvas:'delivered-mini'},
    {key:'replies', name:'Ответы от ЛПР', canvas:'replies-mini'},
    {key:'bounces', name:'Ошибки доставки', canvas:'bounces-mini'},
  ];
  cards.forEach(c=>{
    document.getElementById(c.key+'-total').textContent = fmt.format(sum(S[c.key].map(x=>x.value)));
    sparkline(c.canvas, S[c.key]);
  });

  // open modal on click
  document.querySelectorAll('.card.clickable').forEach(card=>{
    card.addEventListener('click', ()=>{
      const key = card.dataset.metric;
      openMetricModal(key);
    });
  });
}

function openMetricModal(key){
  const map = {
    sent: {title:'Отправлено писем', color:'rgba(110,168,254,.9)'},
    delivered: {title:'Доставлено', color:'rgba(80,220,130,.9)'},
    replies: {title:'Ответы от ЛПР', color:'rgba(235,182,87,.95)'},
    bounces: {title:'Ошибки доставки', color:'rgba(255,107,107,.95)'}
  };
  const conf = map[key];
  const arr = DATA.series[key];
  const {labels, values} = toXY(arr);
  const ctxColor = conf.color;

  openModal({
    title: conf.title,
    sub: INFO[key],
    seriesKey:key,
    buildChart:(canvas)=>{
      const ctx = canvas.getContext('2d');
      const grad = gradient(ctx, ctxColor.replace('1)', '.22)'));
      return new Chart(ctx, {
        type:'line',
        data:{ labels, datasets:[{ label: conf.title, data: values, tension:.35, pointRadius:2, borderWidth:2, borderColor: ctxColor, backgroundColor:grad, fill:true }]},
        options:{
          responsive:true, maintainAspectRatio:false,
          plugins:{ legend:{display:false}, tooltip:{mode:'index', intersect:false}},
          scales:{
            x:{ title:{display:true, text:'Дата'}, ticks:{ maxRotation:0, color:'#9aa3b2'} },
            y:{ title:{display:true, text:'Количество'}, ticks:{ color:'#9aa3b2'}, grid:{ color:'rgba(255,255,255,.06)'} }
          }
        }
      });
    },
    foot:[
      {label:'Текущее значение (последний день)', value: fmt.format(last(arr).value)},
      {label:'Прогноз на неделю при текущем темпе', value: fmt.format(forecast7(arr))}
    ]
  });
}

function initDynamics(d){
  const open = d.series.opens;
  const rep = d.series.replies;
  const {labels: L1, values: V1} = toXY(open);
  const {values: V2} = toXY(rep);
  const ctx = document.getElementById('dynamics').getContext('2d');
  const grad1 = gradient(ctx, 'rgba(110,168,254,.22)');
  const grad2 = gradient(ctx, 'rgba(235,182,87,.22)');
  new Chart(ctx, {
    type:'line',
    data:{ labels: L1, datasets:[
      {label:'Открытия', data: V1, tension:.35, borderColor:'rgba(110,168,254,.9)', backgroundColor:grad1, fill:true, pointRadius:2, borderWidth:2},
      {label:'Ответы', data: V2, tension:.35, borderColor:'rgba(235,182,87,.95)', backgroundColor:grad2, fill:true, pointRadius:2, borderWidth:2}
    ]},
    options:{
      plugins:{ tooltip:{mode:'index', intersect:false}},
      scales:{
        x:{ title:{display:true,text:'Дата'}, ticks:{ color:'#9aa3b2'} },
        y:{ title:{display:true,text:'Количество'}, ticks:{ color:'#9aa3b2'}, grid:{ color:'rgba(255,255,255,.06)'} }
      }
    }
  });
}

function initFunnel(d){
  const s = sum(d.series.sent.map(x=>x.value));
  const o = sum(d.series.opens.map(x=>x.value));
  const r = sum(d.series.replies.map(x=>x.value));
  const ctx = document.getElementById('funnel').getContext('2d');
  new Chart(ctx, {
    type:'bar',
    data:{ labels:['Отправлено','Открыто','Ответы ЛПР'], datasets:[{data:[s,o,r], backgroundColor:['rgba(110,168,254,.9)','rgba(110,168,254,.6)','rgba(235,182,87,.9)']}]},
    options:{
      plugins:{legend:{display:false}, tooltip:{mode:'index', intersect:false}},
      scales:{ x:{ticks:{color:'#9aa3b2'}}, y:{ticks:{color:'#9aa3b2'}, grid:{color:'rgba(255,255,255,.06)'}}}
    }
  });
}

function initQuality(d){
  const sent = sum(d.series.sent.map(x=>x.value));
  const delivered = sum(d.series.delivered.map(x=>x.value));
  const rate = delivered/sent;
  document.getElementById('quality-val').textContent = (rate*100).toFixed(1)+'%';
  const ctx = document.getElementById('quality').getContext('2d');
  new Chart(ctx, {
    type:'doughnut',
    data:{
      labels:['Успешно','Ошибки'],
      datasets:[{data:[delivered, sent-delivered], backgroundColor:['rgba(80,220,130,.9)','rgba(255,107,107,.9)']}]
    },
    options:{ plugins:{legend:{position:'bottom'}}}
  });
}

function initSectors(d){
  const tbody = document.querySelector('#sectors-table tbody');
  tbody.innerHTML = '';
  const avgOpen = d.industries.reduce((a,b)=>a+b.open_rate,0)/d.industries.length;
  const avgReply = d.industries.reduce((a,b)=>a+b.reply_rate,0)/d.industries.length;
  d.industries.forEach(it=>{
    const diffOpen = (it.open_rate-avgOpen)/avgOpen;
    const diffReply = (it.reply_rate-avgReply)/avgReply;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${it.name}</td>
      <td>${fmt.format(it.sent)}</td>
      <td>${pct(it.open_rate)}</td>
      <td>${pct(it.reply_rate)}</td>
      <td>${arrow(diffOpen)}</td>
      <td>${arrow(diffReply)}</td>`;
    tbody.appendChild(tr);
  });
}
function arrow(diff){
  const cls = diff>=0 ? 'up' : 'down';
  const sign = diff>=0 ? '▲' : '▼';
  return `<span class="arrow ${cls}">${sign} ${(Math.abs(diff)*100).toFixed(1)}%</span>`;
}

// Modal infra
let modalChart=null;
function openModal({title, sub, seriesKey, buildChart, foot=[], infoHTML=''}){
  document.getElementById('modal-title').textContent = title;
  document.getElementById('modal-sub').textContent = sub || '';
  document.getElementById('modal-legend').innerHTML = '';
  document.getElementById('modal-foot').innerHTML = '';
  const m = document.getElementById('modal');
  const canvas = document.getElementById('modal-chart');
  if(modalChart){ modalChart.destroy(); modalChart=null; }
  if(buildChart){
    modalChart = buildChart(canvas);
  } else {
    // show info-only
    const legend = document.getElementById('modal-legend');
    legend.innerHTML = infoHTML;
  }
  const footBox = document.getElementById('modal-foot');
  foot.forEach(f=>{
    const el = document.createElement('div');
    el.innerHTML = `<div class="muted" style="font-size:11px">${f.label}</div><div style="font-weight:700">${f.value}</div>`;
    footBox.appendChild(el);
  });
  m.classList.add('open');
}
document.getElementById('modal-close').addEventListener('click', ()=> document.getElementById('modal').classList.remove('open'));
document.getElementById('modal').addEventListener('click', (e)=>{ if(e.target.id==='modal') e.currentTarget.classList.remove('open'); });
</script>
</body>
</html>
