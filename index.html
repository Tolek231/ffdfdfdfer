<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>WandLead · Личный кабинет (обновлён)</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
:root{
  --bg:#0a0d12;
  --surface:#0f141b;
  --panel:#0c1117;
  --card:#101720;
  --text:#e9eef6;
  --muted:#9aa3b2;
  --line:#161e28;
  --accent:#71a4ff;
  --accent2:#8a5cf6;
  --good:#1fce7a;
  --warn:#ebb657;
  --bad:#ff6b6b;
  --ring:rgba(113,164,255,.4);
  --radius:16px;
  --shadow: 0 10px 30px rgba(0,0,0,.35);
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,Arial;
  color:var(--text);
  background:
    radial-gradient(1200px 500px at 10% -10%, rgba(113,164,255,.15), transparent),
    radial-gradient(900px 480px at 90% -10%, rgba(138,92,246,.12), transparent),
    var(--bg);
}

/* Top bar */
.header{
  position:sticky;top:0;z-index:40;
  background:linear-gradient(180deg, rgba(10,13,18,.9), rgba(10,13,18,.6), transparent);
  backdrop-filter: blur(6px);
  border-bottom:1px solid rgba(255,255,255,.06);
}
.container{max-width:1200px;margin:0 auto;padding:18px 18px 0}
.brand{
  display:flex;align-items:center;gap:12px;font-weight:800;letter-spacing:.3px
}
.brand .logo{
  width:26px;height:26px;border-radius:8px;
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  box-shadow:0 0 0 8px rgba(113,164,255,.12);
}
.sub{color:var(--muted);font-size:12px}

/* Tabs */
.tabs{display:flex;gap:8px;margin:12px 0 16px}
.tab{
  padding:10px 14px;border-radius:12px;
  background:linear-gradient(180deg,#141b25,#0f151d);
  border:1px solid rgba(255,255,255,.07); color:#cfd5e1; cursor:pointer; transition:.15s;
}
.tab:hover{box-shadow:0 0 0 6px rgba(113,164,255,.08)}
.tab.active{background:linear-gradient(180deg,#1a2230,#121923); color:var(--text); box-shadow:var(--shadow)}

/* Layout */
.main{max-width:1200px;margin:0 auto;padding:6px 18px 48px}
.grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
.card{
  grid-column:span 6;
  background:linear-gradient(180deg,#121a25,#0e151f);
  border:1px solid rgba(255,255,255,.07);
  border-radius:var(--radius);
  box-shadow: var(--shadow);
  padding:14px; position:relative; overflow:hidden;
}
.card.small{grid-column:span 6}
@media (min-width: 900px){
  .card.small{grid-column:span 3}
}
.card.full{grid-column:span 12}
.card-title{display:flex;align-items:center;gap:10px;margin:0 0 6px 0;font-size:14px;font-weight:800;color:#dce4f1}
.card-sub{color:#aab3c2;font-size:12px;margin-top:-2px}
.kpi{display:flex;align-items:end;gap:10px;margin-bottom:8px}
.kpi .big{font-size:28px;font-weight:800;letter-spacing:.3px}
.muted{color:var(--muted);font-size:12px}
.info{
  width:18px;height:18px;border-radius:999px;display:grid;place-items:center;font-size:12px;cursor:pointer;
  background:linear-gradient(180deg,#1a2330,#121922);border:1px solid rgba(255,255,255,.08);color:#aeb9c9
}
.info:hover{box-shadow:0 0 0 6px rgba(113,164,255,.08); color:#fff}

/* Chart wrappers */
.chart-box{height:180px;position:relative}
.chart-box.tall{height:320px}
.chart-box.pie{height:260px}
.chart-box canvas{width:100%!important;height:100%!important}

/* Funnel */
.funnel{
  display:flex;flex-direction:column;justify-content:center;gap:10px;height:100%;
}
.funnel .row{position:relative;height:64px;display:flex;align-items:center;justify-content:center}
.funnel .shape{
  height:100%; margin:0 auto; border-radius:14px;
  background:linear-gradient(135deg, rgba(113,164,255,.35), rgba(138,92,246,.25));
  border:1px solid rgba(255,255,255,.08);
  box-shadow: inset 0 0 0 1px rgba(255,255,255,.04), 0 6px 18px rgba(0,0,0,.25);
}
.funnel .row:nth-child(2) .shape{ background:linear-gradient(135deg, rgba(113,164,255,.28), rgba(138,92,246,.18)); }
.funnel .row:nth-child(3) .shape{ background:linear-gradient(135deg, rgba(235,182,87,.35), rgba(138,92,246,.18)); }
.funnel .label{
  position:absolute; inset:0; display:flex; align-items:center; justify-content:space-between;
  padding:0 14px; font-weight:700; font-size:13px; color:#e9eef6;
}
.funnel .label .muted{font-size:11px}
/* tapered illusion */
.funnel .row:nth-child(1) .shape{width:92%}
.funnel .row:nth-child(2) .shape{width:74%}
.funnel .row:nth-child(3) .shape{width:44%}

/* Table */
table{width:100%;border-collapse:collapse;margin-top:8px}
th,td{padding:12px 10px;border-bottom:1px solid rgba(255,255,255,.06);text-align:left}
th{color:#cfd7e6;font-weight:600}

/* Arrows */
.arrow{display:inline-flex;align-items:center;gap:6px;font-weight:600}
.arrow.up{color:var(--good)}
.arrow.down{color:var(--bad)}

/* Modal */
.modal{position:fixed;inset:0;background:rgba(5,8,12,.7);display:none;align-items:center;justify-content:center;z-index:50}
.modal.open{display:flex}
.modal .box{width:min(940px,92vw);background:linear-gradient(180deg,#141c28,#0f1620);border:1px solid rgba(255,255,255,.08);border-radius:20px;box-shadow:var(--shadow);padding:18px 18px 14px}
.modal .head{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.modal .title{font-size:18px;font-weight:800}
.modal .close{background:#182131;border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:8px 10px;color:#cfd5e1;cursor:pointer}
.legend{display:flex;gap:14px;align-items:center;flex-wrap:wrap;margin:8px 0 2px}
.foot{display:flex;gap:16px;flex-wrap:wrap;margin-top:10px}
.foot div{background:#0f161f;border:1px solid rgba(255,255,255,.06);border-radius:12px;padding:10px 12px}
.hidden{display:none}
.sep{height:1px;background:rgba(255,255,255,.06);margin:10px 0}
</style>
</head>
<body>
  <div class="header">
    <div class="container">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="brand"><div class="logo"></div><div>WandLead · Личный кабинет</div></div>
        <div class="sub" id="period">Период: —</div>
      </div>
      <div class="tabs">
        <div class="tab active" data-tab="overview">Обзор</div>
        <div class="tab" data-tab="sectors">Сферы</div>
      </div>
    </div>
  </div>

  <main class="main">
    <section id="overview" class="grid">
      <div class="card small clickable" data-metric="sent">
        <div class="card-title">Отправлено <span class="info" data-info="sent">i</span></div>
        <div class="kpi"><div class="big" id="sent-total">—</div><span class="muted">за 7 дней</span></div>
        <div class="chart-box"><canvas id="sent-mini"></canvas></div>
      </div>
      <div class="card small clickable" data-metric="delivered">
        <div class="card-title">Доставлено <span class="info" data-info="delivered">i</span></div>
        <div class="kpi"><div class="big" id="delivered-total">—</div><span class="muted">за 7 дней</span></div>
        <div class="chart-box"><canvas id="delivered-mini"></canvas></div>
      </div>
      <div class="card small clickable" data-metric="replies">
        <div class="card-title">Ответы ЛПР <span class="info" data-info="replies">i</span></div>
        <div class="kpi"><div class="big" id="replies-total">—</div><span class="muted">за 7 дней</span></div>
        <div class="chart-box"><canvas id="replies-mini"></canvas></div>
      </div>
      <div class="card small clickable" data-metric="bounces">
        <div class="card-title">Ошибки доставки <span class="info" data-info="bounces">i</span></div>
        <div class="kpi"><div class="big" id="bounces-total">—</div><span class="muted">за 7 дней</span></div>
        <div class="chart-box"><canvas id="bounces-mini"></canvas></div>
      </div>

      <div class="card full">
        <div class="card-title">Динамика (7 дней): открытия vs ответы <span class="info" data-info="dynamics">i</span></div>
        <div class="card-sub">Компактные даты и аккуратные подсказки — без лишнего текста.</div>
        <div class="chart-box tall"><canvas id="dynamics"></canvas></div>
      </div>

      <div class="card">
        <div class="card-title">Воронка за 7 дней <span class="info" data-info="funnel">i</span></div>
        <div class="chart-box" id="funnel-box">
          <!-- Будет отрисовано как наглядная воронка -->
        </div>
      </div>
      <div class="card">
        <div class="card-title">Качество доставки <span class="info" data-info="quality">i</span></div>
        <div class="kpi"><div class="big" id="quality-val">—%</div><span class="muted">успешных доставок</span></div>
        <div class="chart-box pie"><canvas id="quality"></canvas></div>
      </div>
    </section>

    <section id="sectors" class="hidden">
      <div class="card full">
        <div class="card-title">Сферы и их эффективность <span class="info" data-info="sectors">i</span></div>
        <table id="sectors-table">
          <thead><tr><th>Сфера</th><th>Отправлено</th><th>Открытия</th><th>Ответы</th><th>К открываемости</th><th>К ответам</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- Modal -->
  <div class="modal" id="modal">
    <div class="box">
      <div class="head">
        <div class="title" id="modal-title">Модалка</div>
        <button class="close" id="modal-close">Закрыть</button>
      </div>
      <div class="sub" id="modal-sub"></div>
      <div class="sep"></div>
      <div class="chart-box tall"><canvas id="modal-chart"></canvas></div>
      <div class="legend" id="modal-legend"></div>
      <div class="foot" id="modal-foot"></div>
    </div>
  </div>

<script>
// Info texts (короче и понятнее)
const INFO = {
  sent: "Исходящие письма за последние 7 дней.",
  delivered: "Успешно доставленные письма (без bounce) за 7 дней.",
  replies: "Уникальные ответы ЛПР за 7 дней.",
  bounces: "Ошибки доставки за 7 дней.",
  dynamics: "Открытия и ответы по дням за неделю.",
  funnel: "Отправлено → Открыто → Ответы ЛПР за неделю. Ширина — доля от отправленных.",
  quality: "Доля доставленных: Доставлено / Отправлено за 7 дней.",
  sectors: "Сферы. Стрелки показывают отклонение от среднего."
};

const fmt = new Intl.NumberFormat('ru-RU');
const dateShort = new Intl.DateTimeFormat('ru-RU',{day:'2-digit', month:'2-digit'});
const dateTooltip = new Intl.DateTimeFormat('ru-RU',{day:'2-digit', month:'short'});
let DATA = null;

// Tabs
document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click',()=>{
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  t.classList.add('active');
  document.querySelectorAll('main > section').forEach(s=>s.classList.add('hidden'));
  document.getElementById(t.dataset.tab).classList.remove('hidden');
}));

// Info
document.addEventListener('click', (e)=>{
  if(e.target.classList.contains('info')){
    const key = e.target.dataset.info;
    openModal({ title:'Что означает блок', sub: INFO[key] });
    e.stopPropagation();
  }
});

// Load data with graceful fallback filename
function loadData(){
  return fetch('data.txt').then(r=>{
    if(!r.ok) throw new Error('no data.txt');
    return r.json();
  }).catch(()=> fetch('data (4).txt').then(r=>r.json()));
}
loadData().then(json=>{
  DATA = json;
  hydrateLast7();
  initOverview();
  initDynamics();
  initFunnel();
  initQuality();
  initSectors();
}).catch(()=> alert('Не удалось загрузить данные'));

// --- Helpers ---
function toXY(arr){ return { labels: arr.map(p=>p.date), values: arr.map(p=>p.value) }; }
function sum(arr){ return arr.reduce((a,b)=>a+b,0); }
function avg(arr){ return sum(arr)/arr.length; }
function last(arr){ return arr[arr.length-1]; }
function forecast7(arr){ const sl = arr.slice(-7).map(x=>x.value); return Math.round(avg(sl)*7); }

function grad(ctx, color){
  const g = ctx.createLinearGradient(0,0,0,300);
  g.addColorStop(0,color);
  g.addColorStop(1,'rgba(0,0,0,0)');
  return g;
}

// Keep only last 7 days across series + compact period label
function hydrateLast7(){
  const S = DATA.series;
  Object.keys(S).forEach(k=>{
    S[k] = S[k].slice(-7);
  });
  const start = new Date(DATA.series.sent[0].date);
  const end = new Date(DATA.series.sent.at(-1).date);
  const monthShort = new Intl.DateTimeFormat('ru-RU',{month:'short'});
  const range = `${start.getDate()}–${end.getDate()} ${monthShort.format(end)}`;
  document.getElementById('period').textContent = 'Последние 7 дней: ' + range;
}

function spark(canvasId, arr, color='rgba(113,164,255,.95)'){
  const {labels, values} = toXY(arr);
  const shortLabels = labels.map(d=> dateShort.format(new Date(d)));
  const ctx = document.getElementById(canvasId).getContext('2d');
  return new Chart(ctx, {
    type:'line',
    data:{labels:shortLabels, datasets:[{data:values, tension:.35, borderWidth:2, borderColor:color, pointRadius:0, fill:true, backgroundColor:grad(ctx, color.replace('.95', '.22'))}]},
    options:{
      responsive:true, maintainAspectRatio:false,
      plugins:{legend:{display:false}, tooltip:{mode:'index', intersect:false, backgroundColor:'#111827',
        callbacks:{title:(it)=> dateTooltip.format(new Date(DATA.series.sent[it[0].dataIndex].date))}}},
      scales:{x:{display:false},y:{display:false}}
    }
  });
}

function initOverview(){
  const S = DATA.series;
  document.getElementById('sent-total').textContent = fmt.format(sum(S.sent.map(x=>x.value)));
  document.getElementById('delivered-total').textContent = fmt.format(sum(S.delivered.map(x=>x.value)));
  document.getElementById('replies-total').textContent = fmt.format(sum(S.replies.map(x=>x.value)));
  document.getElementById('bounces-total').textContent = fmt.format(sum(S.bounces.map(x=>x.value)));
  spark('sent-mini', S.sent, 'rgba(113,164,255,.95)');
  spark('delivered-mini', S.delivered, 'rgba(31,206,122,.95)');
  spark('replies-mini', S.replies, 'rgba(235,182,87,.95)');
  spark('bounces-mini', S.bounces, 'rgba(255,107,107,.95)');

  document.querySelectorAll('.card.clickable').forEach(c=>{
    c.addEventListener('click', ()=> openMetricModal(c.dataset.metric));
  });
}

function initDynamics(){
  const open = DATA.series.opens;
  const rep = DATA.series.replies;
  const {labels, values: v1} = toXY(open);
  const {values: v2} = toXY(rep);
  const shortLabels = labels.map(d=> dateShort.format(new Date(d)));
  const ctx = document.getElementById('dynamics').getContext('2d');
  new Chart(ctx, {
    type:'line',
    data:{labels:shortLabels, datasets:[
      {label:'Открытия', data:v1, tension:.35, borderWidth:2, pointRadius:2, borderColor:'rgba(113,164,255,.95)', backgroundColor:grad(ctx,'rgba(113,164,255,.22)'), fill:true},
      {label:'Ответы', data:v2, tension:.35, borderWidth:2, pointRadius:2, borderColor:'rgba(235,182,87,.95)', backgroundColor:grad(ctx,'rgba(235,182,87,.22)'), fill:true},
    ]},
    options:{
      responsive:true, maintainAspectRatio:false,
      plugins:{legend:{labels:{color:'#d6deea'}}, tooltip:{mode:'index', intersect:false, callbacks:{
        title:(it)=> dateTooltip.format(new Date(DATA.series.opens[it[0].dataIndex].date))
      }}},
      scales:{ x:{ticks:{color:'#9aa3b2', maxRotation:0, autoSkip:true, maxTicksLimit:7}, grid:{color:'rgba(255,255,255,.05)'}},
               y:{ticks:{color:'#9aa3b2'}, grid:{color:'rgba(255,255,255,.05)'}} }
    }
  });
}

function initFunnel(){
  const s = sum(DATA.series.sent.map(x=>x.value));
  const o = sum(DATA.series.opens.map(x=>x.value));
  const r = sum(DATA.series.replies.map(x=>x.value));
  const openRate = o/s;
  const replyRate = r/s;

  const box = document.getElementById('funnel-box');
  box.innerHTML = `
    <div class="funnel">
      <div class="row">
        <div class="shape"></div>
        <div class="label"><span>Отправлено</span><span>${fmt.format(s)} <span class="muted">(100%)</span></span></div>
      </div>
      <div class="row">
        <div class="shape"></div>
        <div class="label"><span>Открыто</span><span>${fmt.format(o)} <span class="muted">(${(openRate*100).toFixed(1)}%)</span></span></div>
      </div>
      <div class="row">
        <div class="shape"></div>
        <div class="label"><span>Ответы ЛПР</span><span>${fmt.format(r)} <span class="muted">(${(replyRate*100).toFixed(1)}%)</span></span></div>
      </div>
    </div>
  `;
}

function initQuality(){
  const sent = sum(DATA.series.sent.map(x=>x.value));
  const delivered = sum(DATA.series.delivered.map(x=>x.value));
  const rate = delivered/sent;
  document.getElementById('quality-val').textContent = (rate*100).toFixed(1)+'%';
  const ctx = document.getElementById('quality').getContext('2d');
  new Chart(ctx, {
    type:'doughnut',
    data:{ labels:['Успешно','Ошибки'], datasets:[{ data:[delivered, sent-delivered], cutout:'72%', borderWidth:0, backgroundColor:['rgba(31,206,122,.95)','rgba(255,107,107,.95)'] }]},
    options:{ plugins:{legend:{position:'bottom', labels:{color:'#d6deea'}}}, responsive:true, maintainAspectRatio:false }
  });
}

function initSectors(){
  const tbody = document.querySelector('#sectors-table tbody');
  const arr = DATA.industries;
  const avgOpen = arr.reduce((a,b)=>a+b.open_rate,0)/arr.length;
  const avgReply = arr.reduce((a,b)=>a+b.reply_rate,0)/arr.length;
  tbody.innerHTML = '';
  arr.forEach(it=>{
    const diffOpen = (it.open_rate-avgOpen)/avgOpen;
    const diffReply = (it.reply_rate-avgReply)/avgReply;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${it.name}</td>
      <td>${fmt.format(it.sent)}</td>
      <td>${(it.open_rate*100).toFixed(1)}%</td>
      <td>${(it.reply_rate*100).toFixed(1)}%</td>
      <td>${arrow(diffOpen)}</td>
      <td>${arrow(diffReply)}</td>`;
    tbody.appendChild(tr);
  });
}

function arrow(diff){
  const cls = diff>=0 ? 'up' : 'down';
  const sign = diff>=0 ? '▲' : '▼';
  return `<span class="arrow ${cls}">${sign} ${(Math.abs(diff)*100).toFixed(1)}%</span>`;
}

// Modal
let modalChart=null;
function openMetricModal(key){
  const conf = {
    sent: {title:'Отправлено', color:'rgba(113,164,255,.95)'},
    delivered: {title:'Доставлено', color:'rgba(31,206,122,.95)'},
    replies: {title:'Ответы ЛПР', color:'rgba(235,182,87,.95)'},
    bounces: {title:'Ошибки доставки', color:'rgba(255,107,107,.95)'},
  }[key];
  const arr = DATA.series[key];
  const {labels, values} = toXY(arr);
  const shortLabels = labels.map(d=> dateShort.format(new Date(d)));
  openModal({
    title: conf.title + ' (7 дней)',
    sub: INFO[key],
    builder: (canvas)=>{
      const ctx = canvas.getContext('2d');
      if(modalChart) modalChart.destroy();
      modalChart = new Chart(ctx,{
        type:'line',
        data:{labels:shortLabels, datasets:[{label:conf.title, data:values, tension:.35, borderWidth:2, pointRadius:2, borderColor:conf.color, backgroundColor:grad(ctx, conf.color.replace('.95','.22')), fill:true}]},
        options:{
          responsive:true, maintainAspectRatio:false,
          plugins:{legend:{display:false}, tooltip:{mode:'index', intersect:false, callbacks:{
            title:(it)=> dateTooltip.format(new Date(DATA.series[key][it[0].dataIndex].date))
          }}},
          scales:{ x:{ticks:{color:'#9aa3b2'}}, y:{ticks:{color:'#9aa3b2'}} }
        }
      });
    },
    foot:[
      {label:'Текущее (последний день)', value: fmt.format(last(arr).value)},
      {label:'Прогноз на неделю', value: fmt.format(forecast7(arr))}
    ]
  });
}

function openModal({title, sub, builder, foot=[]}){
  const m = document.getElementById('modal');
  document.getElementById('modal-title').textContent = title || '';
  document.getElementById('modal-sub').textContent = sub || '';
  const canvas = document.getElementById('modal-chart');
  if(builder) builder(canvas);
  const footBox = document.getElementById('modal-foot'); footBox.innerHTML='';
  foot.forEach(f=>{ const el = document.createElement('div'); el.innerHTML = `<div class="sub" style="font-size:11px">${f.label}</div><div style="font-weight:800">${f.value}</div>`; footBox.appendChild(el); });
  m.classList.add('open');
}
document.getElementById('modal-close').addEventListener('click', ()=> document.getElementById('modal').classList.remove('open'));
document.getElementById('modal').addEventListener('click', (e)=>{ if(e.target.id==='modal') e.currentTarget.classList.remove('open'); });
</script>
</body>
</html>
