<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>WandLead • Mini App</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  :root{
    --bg:#0b0c10; --fg:#e8e8f1; --muted:#9aa0ad; --line:rgba(255,255,255,0.12);
    --cyan:#67e8f9; --violet:#a78bfa; --chip:linear-gradient(135deg,#00e5ff 0%, #7c3aed 100%);
    --gap:10px; --card-pad:10px; --chart-h:160px; --chart-h-compact:130px;
    --btn-bg: rgba(255,255,255,0.03); --btn-active: rgba(255,255,255,0.08);
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);
    font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,'Helvetica Neue',Arial;}
  *{box-sizing:border-box;letter-spacing:.01em}
  .container{max-width:960px;margin:0 auto;padding:12px 12px 72px;}
  .bar{position:sticky;top:0;z-index:5;background:rgba(11,12,16,.85);backdrop-filter:blur(8px);border-bottom:1px solid var(--line)}
  .bar-inner{max-width:960px;margin:0 auto;padding:8px 12px;display:flex;align-items:center;justify-content:space-between;gap:8px;color:var(--fg)}
  .brand{display:flex;align-items:center;gap:8px}
  .dot{width:20px;height:20px;border-radius:6px;background:linear-gradient(135deg,#00e5ff 0%,#7c3aed 100%);}
  .tabs,.period{display:flex;gap:8px}
  .btn{border:1px solid var(--line);background:var(--btn-bg);color:var(--fg);padding:7px 10px;border-radius:10px;font-size:12px}
  .btn:hover{background:rgba(255,255,255,0.06)}
  .btn.active{background:var(--btn-active);color:var(--fg);border-color:var(--line);box-shadow:0 0 0 1px rgba(255,255,255,0.04) inset}
  .grid{display:grid;gap:var(--gap)}
  .g2{grid-template-columns:repeat(2,minmax(0,1fr))}
  .g3{grid-template-columns:repeat(3,minmax(0,1fr))}
  @media (max-width:720px){.g2{grid-template-columns:1fr}.g3{grid-template-columns:1fr}}
  .card{border:1px solid var(--line);border-radius:14px;background:rgba(255,255,255,0.02);padding:var(--card-pad);color:var(--fg)}
  .label{font-size:10px;text-transform:uppercase;letter-spacing:.08em;color:var(--muted)}
  .section-title{display:flex;align-items:center;justify-content:space-between;margin:6px 0}
  .section-left{display:flex;align-items:center;gap:8px}
  .subtitle{font-size:12px;color:var(--muted)}
  .kpi{display:flex;align-items:flex-end;justify-content:space-between;margin-top:4px}
  .kpi .val{font-size:22px;font-weight:700;tabular-nums:tabular-nums}
  .delta{font-size:11px;border:1px solid;color:#fff;padding:2px 6px;border-radius:8px}
  .delta.pos{border-color:#34d399;color:#34d399}
  .delta.neg{border-color:#f87171;color:#f87171}
  .spark{width:100%;height:28px;margin-top:4px}
  .info{border:1px solid var(--line);border-radius:8px;padding:8px;color:var(--muted);font-size:12px;margin-top:6px;display:none}
  .info.show{display:block}
  .icon-btn{width:22px;height:22px;border:1px solid var(--line);border-radius:50%;background:var(--btn-bg);color:var(--fg);font-size:12px;display:flex;align-items:center;justify-content:center}
  .footer{position:fixed;left:0;right:0;bottom:0;border-top:1px solid var(--line);background:rgba(11,12,16,.9);backdrop-filter:blur(8px)}
  .footer-inner{max-width:960px;margin:0 auto;padding:8px 12px;display:flex;align-items:center;justify-content:space-between;color:var(--muted);font-size:12px}
  .row{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;border-bottom:1px solid rgba(255,255,255,.06)}
  .row:last-child{border-bottom:0}
  .badge{font-size:11px;border:1px solid var(--line);border-radius:8px;padding:3px 8px}
  .sheet{position:fixed;inset:0;z-index:20;display:none}
  .sheet.show{display:block}
  .sheet .bg{position:absolute;inset:0;background:#0008}
  .sheet .panel{position:absolute;left:0;right:0;bottom:0;margin:0 auto;max-width:720px;background:var(--bg);border:1px solid var(--line);border-bottom:0;border-radius:16px 16px 0 0;padding:12px}
  @media (max-height: 780px){ :root{ --chart-h: var(--chart-h-compact); --gap:8px; --card-pad:8px } .kpi .val{font-size:20px} }
  @media (max-height: 680px){ :root{ --chart-h: 120px } }
</style>
</head>
<body>
  <!-- Top Bar -->
  <div class="bar">
    <div class="bar-inner">
      <div class="brand">
        <div class="dot"></div>
        <div id="appTitle" style="font-weight:600">WandLead • Mini</div>
      </div>
      <div class="period" id="periodBtns">
        <button class="btn active" data-period="today"  id="btnToday">День</button>
        <button class="btn"        data-period="week"   id="btnWeek">Неделя</button>
        <button class="btn"        data-period="month"  id="btnMonth">Месяц</button>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Tabs -->
    <div class="tabs" id="tabs">
      <button class="btn active" data-tab="overview" id="tabBtnOverview">Обзор</button>
      <button class="btn" data-tab="sectors" id="tabBtnSectors">Сферы</button>
      <button class="btn" data-tab="activity" id="tabBtnActivity">Активность</button>
    </div>

    <!-- OVERVIEW -->
    <div id="tab-overview" class="grid" style="margin-top:12px">
      <!-- KPIs -->
      <div class="grid g2" id="kpis"></div>

      <!-- Line Chart -->
      <div class="card" id="dynamicCard">
        <div class="section-title">
          <div class="section-left">
            <div id="dynTitle">Динамика (Открытия • Ответы)</div>
            <button class="icon-btn" id="dynInfoBtn">i</button>
          </div>
          <div class="subtitle" id="lineSubtitle">по дням</div>
        </div>
        <div id="dynInfo" class="info"></div>
        <div id="lineWrap" style="width:100%;">
          <svg id="lineChart" viewBox="0 0 720 160" width="100%" height="160"></svg>
        </div>
        <div id="lineTip" class="subtitle" style="margin-top:6px"></div>
      </div>

      <!-- Funnel + Donut -->
      <div class="grid g3">
        <div class="card" style="grid-column:span 2;">
          <div class="section-title">
            <div class="section-left">
              <div id="funnelTitle">Воронка</div>
              <button class="icon-btn" id="funnelInfoBtn">i</button>
            </div>
            <div class="subtitle" id="funnelSub"></div>
          </div>
          <div id="funnelInfo" class="info"></div>
          <div id="funnel" class="grid g3"></div>
        </div>
        <div class="card">
          <div class="section-title">
            <div class="section-left">
              <div id="qualityTitle">Качество доставки</div>
              <button class="icon-btn" id="qualityInfoBtn">i</button>
            </div>
            <div class="subtitle" id="donutSub"></div>
          </div>
          <div id="qualityInfo" class="info"></div>
          <svg id="donut" viewBox="0 0 140 140" width="100%" height="120"></svg>
        </div>
      </div>
    </div>

    <!-- SECTORS -->
    <div id="tab-sectors" class="grid" style="display:none;margin-top:12px">
      <div class="section-title">
        <div class="section-left">
          <div id="sectorsTitle">Сферы: эффективность</div>
          <button class="icon-btn" id="sectorsInfoBtn">i</button>
        </div>
        <div class="tabs">
          <button class="btn active" id="sortReplies">По ответам</button>
          <button class="btn" id="sortOpen">По открытиям</button>
        </div>
      </div>
      <div id="sectorsInfo" class="info"></div>
      <div id="sectorsList" class="grid g2"></div>
    </div>

    <!-- ACTIVITY -->
    <div id="tab-activity" style="display:none;margin-top:12px">
      <div class="card">
        <div class="section-title">
          <div class="section-left">
            <div id="feedTitle">Лента активности</div>
            <button class="icon-btn" id="feedInfoBtn">i</button>
          </div>
          <div class="subtitle" id="activityHint"></div>
        </div>
        <div id="feedInfo" class="info"></div>
        <div id="feed"></div>
      </div>
    </div>
  </div>

  <!-- KPI DETAIL SHEET -->
  <div id="sheet" class="sheet" aria-hidden="true">
    <div class="bg"></div>
    <div class="panel">
      <div class="section-title">
        <div class="label" id="sheetHeader">Детали метрики</div>
        <button class="btn" id="closeSheet">Закрыть</button>
      </div>

      <div id="sheetTitle" style="font-weight:600;font-size:18px"></div>

      <!-- оси и график -->
      <div style="margin-top:10px">
        <svg id="detailChart" viewBox="0 0 340 160" width="100%" height="160"></svg>
        <div class="subtitle" id="detailAxesNote"></div>
      </div>

      <div class="grid g2" style="margin-top:8px">
        <div class="card">
          <div class="label" id="curLabel">Текущее значение</div>
          <div id="sheetCur" style="margin-top:4px;font-size:14px;color:#34d399"></div>
        </div>
        <div class="card">
          <div class="label" id="chgLabel">Изменение к периоду</div>
          <div id="sheetDelta" style="margin-top:4px;font-size:14px"></div>
        </div>
      </div>

      <div class="card" style="margin-top:8px">
        <div class="label" id="defLabel">Что означает метрика</div>
        <div id="sheetDef" class="subtitle" style="margin-top:4px"></div>
      </div>
      <div class="card" style="margin-top:8px">
        <div class="label" id="howLabel">Как считается</div>
        <div id="sheetHow" class="subtitle" style="margin-top:4px"></div>
      </div>
      <div class="card" style="margin-top:8px">
        <div class="label" id="imprLabel">Как улучшить</div>
        <div id="sheetImpr" class="subtitle" style="margin-top:4px"></div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <div class="footer">
    <div class="footer-inner">
      <div class="subtitle" id="footerCopy">© 2025 WandLead</div>
      <div class="tabs">
        <button class="btn" id="exportCsv">Экспорт CSV</button>
        <button class="btn" id="shareBtn">Поделиться</button>
      </div>
    </div>
  </div>

<script>
/* Telegram init */
(function(){
  if (window.Telegram && Telegram.WebApp) {
    try { Telegram.WebApp.ready(); Telegram.WebApp.expand(); } catch(e){}
  }
})();
const fmt = (n)=> n.toLocaleString('ru-RU');
const clamp = (x,a,b)=> Math.max(a, Math.min(b, x));
function trendPct(arr){ if(!arr||arr.length<2) return 0; const a=arr[0], b=arr[arr.length-1]; return a?Math.round(((b-a)/a)*100):0; }
function cssVar(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }

/* State & refs */
let DATA=null, PERIOD='today', SORT='replies', ACTIVE_TAB='overview';
const periodBtns = document.getElementById('periodBtns');
const tabs = document.getElementById('tabs');
const kpisBox = document.getElementById('kpis');
const lineSvg = document.getElementById('lineChart');
const lineWrap = document.getElementById('lineWrap');
const lineSubtitle = document.getElementById('lineSubtitle');
const lineTip = document.getElementById('lineTip');
const dynInfoBtn = document.getElementById('dynInfoBtn');
const dynInfo = document.getElementById('dynInfo');
const funnelInfoBtn = document.getElementById('funnelInfoBtn');
const funnelInfo = document.getElementById('funnelInfo');
const qualityInfoBtn = document.getElementById('qualityInfoBtn');
const qualityInfo = document.getElementById('qualityInfo');
const sectorsInfoBtn = document.getElementById('sectorsInfoBtn');
const sectorsInfo = document.getElementById('sectorsInfo');
const feedInfoBtn = document.getElementById('feedInfoBtn');
const feedInfo = document.getElementById('feedInfo');
const funnelBox = document.getElementById('funnel');
const donutSvg = document.getElementById('donut');
const donutSub = document.getElementById('donutSub');
const sectorsList = document.getElementById('sectorsList');
const sortReplies = document.getElementById('sortReplies');
const sortOpen = document.getElementById('sortOpen');
const feed = document.getElementById('feed');
const activityHint = document.getElementById('activityHint');
const sheet = document.getElementById('sheet');
const closeSheet = document.getElementById('closeSheet');
const sheetTitle = document.getElementById('sheetTitle');
const sheetCur = document.getElementById('sheetCur');
const sheetDelta = document.getElementById('sheetDelta');
const detailSvg = document.getElementById('detailChart');
const detailAxesNote = document.getElementById('detailAxesNote');
const sheetDef = document.getElementById('sheetDef');
const sheetHow = document.getElementById('sheetHow');
const sheetImpr = document.getElementById('sheetImpr');
const tabOverview = document.getElementById('tab-overview');
const tabSectors = document.getElementById('tab-sectors');
const tabActivity = document.getElementById('tab-activity');

/* Load data ONLY from data.txt */
fetch('data.txt?ts='+Date.now())
  .then(r => r.text())
  .then(t => JSON.parse(t))
  .then(json => { DATA=json; hydrateUiText(); renderAll(); attachResize(); })
  .catch(err => { console.error(err); alert('Ошибка загрузки data.txt'); });

function hydrateUiText(){
  // Заголовки/подписи/подсказки из файла
  document.getElementById('appTitle').textContent = DATA.ui.title;
  document.getElementById('btnToday').textContent = DATA.ui.buttons.today;
  document.getElementById('btnWeek').textContent  = DATA.ui.buttons.week;
  document.getElementById('btnMonth').textContent = DATA.ui.buttons.month;
  document.getElementById('tabBtnOverview').textContent = DATA.ui.tabs.overview;
  document.getElementById('tabBtnSectors').textContent  = DATA.ui.tabs.sectors;
  document.getElementById('tabBtnActivity').textContent = DATA.ui.tabs.activity;

  document.getElementById('dynTitle').textContent     = DATA.ui.sections.dynamic.title;
  document.getElementById('funnelTitle').textContent  = DATA.ui.sections.funnel.title;
  document.getElementById('qualityTitle').textContent = DATA.ui.sections.quality.title;
  document.getElementById('sectorsTitle').textContent = DATA.ui.sections.sectors.title;
  document.getElementById('feedTitle').textContent    = DATA.ui.sections.feed.title;
  document.getElementById('footerCopy').textContent   = DATA.ui.footer;

  dynInfo.textContent     = DATA.ui.sections.dynamic.info;
  funnelInfo.textContent  = DATA.ui.sections.funnel.info;
  qualityInfo.textContent = DATA.ui.sections.quality.info;
  sectorsInfo.textContent = DATA.ui.sections.sectors.info;
  feedInfo.textContent    = DATA.ui.sections.feed.info;

  document.getElementById('exportCsv').textContent = DATA.ui.actions.export;
  document.getElementById('shareBtn').textContent  = DATA.ui.actions.share;
}

function renderAll(){
  const d = DATA[PERIOD];
  renderKPIs(d);
  renderLine(d);
  renderFunnel(d);
  renderDonut(d);
  renderSectors();
  renderFeed(d);
  lineSubtitle.textContent = DATA.ui.dynamicSubtitle[PERIOD];
  activityHint.textContent = DATA.ui.activitySubtitle[PERIOD];
}

/* KPI */
function renderKPIs(d){
  kpisBox.innerHTML = '';
  DATA.kpis.forEach(k=>{
    const delta = d.delta[k.key] ?? 0;
    const spark = d.spark[k.key] || [];
    const card = document.createElement('button');
    card.className='card'; card.style.textAlign='left';
    card.addEventListener('click',()=>openSheet(k.key, k.label, d[k.key], spark));

    const top = document.createElement('div'); top.className='label'; top.textContent=k.label;

    const kpi = document.createElement('div'); kpi.className='kpi';
    const val = document.createElement('div'); val.className='val'; val.textContent=fmt(d[k.key]||0);
    const del = document.createElement('div'); del.className='delta '+(delta>=0?'pos':'neg'); del.textContent=(delta>=0?'▲ ':'▼ ')+Math.abs(delta)+'%';
    kpi.append(val, del);

    const sparkSvg = document.createElementNS('http://www.w3.org/2000/svg','svg');
    sparkSvg.setAttribute('viewBox','0 0 160 28'); sparkSvg.setAttribute('width','100%'); sparkSvg.setAttribute('height','28'); sparkSvg.classList.add('spark');
    drawSparkline(sparkSvg, spark, cssVar('--cyan'));

    // описание под KPI (из data.txt)
    const info = document.createElement('div'); info.className='subtitle'; info.style.marginTop='6px'; info.textContent = DATA.ui.kpiHints[k.key];

    card.append(top, kpi, sparkSvg, info);
    kpisBox.appendChild(card);
  });
}

/* Responsive Line chart with guide */
let ro=null;
function attachResize(){
  if (ro) ro.disconnect();
  ro = new ResizeObserver(()=> renderLine(DATA[PERIOD]));
  ro.observe(lineWrap);
}
function renderLine(d){
  const cssH = getComputedStyle(document.documentElement).getPropertyValue('--chart-h').trim();
  const h = parseInt(cssH || '160', 10);
  const w = Math.max(280, Math.floor(lineWrap.getBoundingClientRect().width)); // адаптивно
  const p = 16;

  while(lineSvg.firstChild) lineSvg.removeChild(lineSvg.firstChild);
  lineSvg.setAttribute('viewBox', `0 0 ${w} ${h}`);
  lineSvg.setAttribute('width', w);
  lineSvg.setAttribute('height', h);

  // defs
  const defs = document.createElementNS('http://www.w3.org/2000/svg','defs');
  defs.append(makeFade('cyanFade',  cssVar('--cyan')));
  defs.append(makeFade('violetFade',cssVar('--violet')));
  lineSvg.appendChild(defs);

  // grid
  const gridColor='rgba(255,255,255,0.06)';
  for(let i=0;i<4;i++){
    const y=p + i*((h-p*2)/3);
    const ln = document.createElementNS('http://www.w3.org/2000/svg','line');
    ln.setAttribute('x1',p); ln.setAttribute('x2',w-p); ln.setAttribute('y1',y); ln.setAttribute('y2',y);
    ln.setAttribute('stroke',gridColor); lineSvg.appendChild(ln);
  }

  const maxY = Math.max(...d.byDay, ...d.repliesByDay) * 1.15;
  const pathOpen = buildPath(d.byDay, w, h, p, maxY);
  const pathReply = buildPath(d.repliesByDay, w, h, p, maxY);

  // areas
  const areaOpen = document.createElementNS('http://www.w3.org/2000/svg','path');
  areaOpen.setAttribute('d', pathOpen + ` L ${w-p},${h-p} L ${p},${h-p} Z`);
  areaOpen.setAttribute('fill','url(#cyanFade)');
  const areaReply = document.createElementNS('http://www.w3.org/2000/svg','path');
  areaReply.setAttribute('d', pathReply + ` L ${w-p},${h-p} L ${p},${h-p} Z`);
  areaReply.setAttribute('fill','url(#violetFade)');
  lineSvg.append(areaOpen, areaReply);

  // lines
  lineSvg.append(svgPath(pathOpen,  cssVar('--cyan'),  2.2));
  lineSvg.append(svgPath(pathReply, cssVar('--violet'),2.2));

  // guide + markers
  const guide = document.createElementNS('http://www.w3.org/2000/svg','line');
  guide.setAttribute('y1', p); guide.setAttribute('y2', h-p);
  guide.setAttribute('stroke','rgba(255,255,255,0.28)'); guide.style.display='none';
  lineSvg.appendChild(guide);
  const mOpen  = document.createElementNS('http://www.w3.org/2000/svg','circle');
  mOpen.setAttribute('r','4');  mOpen.setAttribute('fill', cssVar('--cyan'));  mOpen.style.display='none';
  const mReply = document.createElementNS('http://www.w3.org/2000/svg','circle');
  mReply.setAttribute('r','4'); mReply.setAttribute('fill', cssVar('--violet')); mReply.style.display='none';
  lineSvg.append(mOpen, mReply);

  function moveGuide(clientX){
    const rect = lineSvg.getBoundingClientRect();
    const x = clientX - rect.left;
    const i = Math.round(((x - p) / (w - p*2)) * (d.byDay.length - 1));
    if (i<0 || i>=d.byDay.length) return hideGuide();
    const cx = p + (i * (w - p*2)) / (d.byDay.length - 1);
    guide.setAttribute('x1', cx); guide.setAttribute('x2', cx);
    guide.style.display='block';
    const yOpen  = h - p - (d.byDay[i]        / maxY) * (h - p*2);
    const yReply = h - p - (d.repliesByDay[i] / maxY) * (h - p*2);
    mOpen.setAttribute('cx', cx);  mOpen.setAttribute('cy', yOpen);  mOpen.style.display='block';
    mReply.setAttribute('cx', cx); mReply.setAttribute('cy', yReply); mReply.style.display='block';
    lineTip.textContent = DATA.ui.dynamicPoint
      .replace('{i}', (i+1))
      .replace('{open}', d.byDay[i])
      .replace('{reply}', d.repliesByDay[i]);
  }
  function hideGuide(){ guide.style.display='none'; mOpen.style.display='none'; mReply.style.display='none'; }

  lineSvg.onmousemove = (e)=> moveGuide(e.clientX);
  lineSvg.onmouseleave = hideGuide;
  lineSvg.addEventListener('touchstart', (e)=> { if(e.touches[0]) moveGuide(e.touches[0].clientX); }, {passive:true});
  lineSvg.addEventListener('touchmove',  (e)=> { if(e.touches[0]) moveGuide(e.touches[0].clientX); }, {passive:true});
}

/* Funnel */
function renderFunnel(d){
  funnelBox.innerHTML = '';
  const steps = DATA.funnelOrder.map(key => ({label: DATA.labels[key] || key, val: d[key]}));
  const max = Math.max(...steps.map(s=>s.val));
  document.getElementById('funnelSub').textContent = DATA.ui.funnelSubtitle;
  steps.forEach(s=>{
    const card = document.createElement('div'); card.className='card';
    const lb = document.createElement('div'); lb.className='label'; lb.textContent=s.label;
    const bar = document.createElement('div'); bar.style.cssText='margin-top:8px;height:8px;border-radius:8px;background:rgba(255,255,255,0.06);overflow:hidden';
    const fill = document.createElement('div'); fill.style.cssText='height:100%;background:linear-gradient(90deg,#00e5ff,#7c3aed)';
    fill.style.width = Math.max(6, (s.val/max)*100) + '%';
    bar.appendChild(fill);
    const v = document.createElement('div'); v.style.cssText='margin-top:4px;font-size:13px'; v.textContent = fmt(s.val);
    card.append(lb, bar, v);
    funnelBox.appendChild(card);
  });
}

/* Donut */
function renderDonut(d){
  const total = Math.max(d.sent, 1);
  const errPct = clamp((d.errors/total)*100, 0, 100);
  donutSub.textContent = DATA.ui.qualitySubtitle.replace('{pct}', Math.round(errPct));
  while(donutSvg.firstChild) donutSvg.removeChild(donutSvg.firstChild);
  const cx=70, cy=70, r=46, circ=2*Math.PI*r;

  const base = circElem('circle',{cx,cy,r, stroke:'rgba(255,255,255,0.08)', 'stroke-width':14, fill:'none'});
  const ring = circElem('circle',{cx,cy,r, stroke:'#1f2937', 'stroke-width':14, fill:'none', transform:'rotate(-90 70 70)'});
  const err  = circElem('circle',{cx,cy,r, stroke:'#ef4444', 'stroke-width':14, fill:'none', 'stroke-linecap':'round', transform:'rotate(-90 70 70)'});
  const errLen = (errPct/100)*circ; err.setAttribute('stroke-dasharray', `${errLen} ${circ - errLen}`);
  const txt = textElem({x:'50%', y:'50%', 'dominant-baseline':'middle', 'text-anchor':'middle', fill:'#ffffff'}, (100 - errPct).toFixed(0)+'%');
  txt.style.fontSize='18px'; txt.style.fontWeight='700';
  donutSvg.append(base, ring, err, txt);
}
function circElem(tag, attrs){ const el = document.createElementNS('http://www.w3.org/2000/svg',tag); for(const k in attrs){ el.setAttribute(k, attrs[k]); } return el; }
function textElem(attrs, text){ const el = document.createElementNS('http://www.w3.org/2000/svg','text'); for(const k in attrs){ el.setAttribute(k, attrs[k]); } el.textContent=text; return el; }

/* Sectors */
function renderSectors(){
  const list = (DATA[PERIOD].sectors||[]).slice();
  list.sort((a,b)=> (SORT==='replies' ? b.reply - a.reply : b.open - a.open));
  sectorsList.innerHTML='';
  list.forEach(s=>{
    const card = document.createElement('div'); card.className='card';
    const head = document.createElement('div'); head.className='row'; head.style.padding='0'; head.style.border='0';
    const name = document.createElement('div'); name.style.fontWeight='600'; name.textContent=s.name;
    const trend = document.createElement('div'); trend.className='badge';
    trend.style.color = s.trend>0?'#34d399': s.trend<0?'#f87171':'var(--fg)';
    trend.textContent = (s.trend>0?'▲ ':'') + (s.trend<0?'▼ ':'') + Math.abs(s.trend) + '%';
    head.append(name, trend);

    const meta = document.createElement('div'); meta.className='subtitle'; meta.textContent = DATA.ui.labels.sectorEmails.replace('{n}', fmt(s.sent));

    const grid = document.createElement('div'); grid.className='grid g2';
    const c1 = document.createElement('div'); c1.className='card'; c1.innerHTML = `<div class="label">${DATA.ui.labels.opens}</div><div style="margin-top:4px"><b>${s.open}%</b></div>`;
    const c2 = document.createElement('div'); c2.className='card'; c2.innerHTML = `<div class="label">${DATA.ui.labels.replies}</div><div style="margin-top:4px"><b>${s.reply}%</b></div>`;

    grid.append(c1,c2);
    card.append(head, meta, grid);
    sectorsList.appendChild(card);
  });
}

/* Feed */
function renderFeed(d){
  feed.innerHTML='';
  const items = DATA.feedTemplate.map(t => {
    const text = t.text
      .replace('{sent}', fmt(d.sent))
      .replace('{opened}', fmt(d.opened))
      .replace('{replies}', fmt(d.replies))
      .replace('{errors}', fmt(d.errors));
    return { type:t.type, title:text };
  });
  items.forEach(row=>{
    const r = document.createElement('div'); r.className='row';
    const left = document.createElement('div'); left.style.display='flex'; left.style.alignItems='center'; left.style.gap='8px';
    const dot = document.createElement('div'); dot.style.width='10px'; dot.style.height='10px'; dot.style.borderRadius='50%';
    dot.style.background = row.type==='reply'? '#34d399' : row.type==='open' ? cssVar('--cyan') : row.type==='error' ? '#f87171' : '#9ca3af';
    const ttl = document.createElement('div'); ttl.textContent = row.title;
    left.append(dot, ttl);
    r.append(left); feed.appendChild(r);
  });
}

/* Interactions */
periodBtns.addEventListener('click', (e)=>{
  const b = e.target.closest('button'); if(!b) return;
  PERIOD = b.dataset.period;
  [...periodBtns.querySelectorAll('button')].forEach(x=>x.classList.remove('active'));
  b.classList.add('active'); renderAll();
});
tabs.addEventListener('click', (e)=>{
  const b = e.target.closest('button'); if(!b) return;
  const tab = b.dataset.tab; ACTIVE_TAB = tab;
  [...tabs.querySelectorAll('button')].forEach(x=>x.classList.remove('active'));
  b.classList.add('active');
  tabOverview.style.display = tab==='overview'?'grid':'none';
  tabSectors.style.display = tab==='sectors'?'grid':'none';
  tabActivity.style.display = tab==='activity'?'block':'none';
});
sortReplies.addEventListener('click', ()=>{ SORT='replies'; sortReplies.classList.add('active'); sortOpen.classList.remove('active'); renderSectors(); });
sortOpen.addEventListener('click',   ()=>{ SORT='open';    sortOpen.classList.add('active');    sortReplies.classList.remove('active'); renderSectors(); });

dynInfoBtn.addEventListener('click', ()=> dynInfo.classList.toggle('show'));
funnelInfoBtn.addEventListener('click', ()=> funnelInfo.classList.toggle('show'));
qualityInfoBtn.addEventListener('click', ()=> qualityInfo.classList.toggle('show'));
sectorsInfoBtn.addEventListener('click', ()=> sectorsInfo.classList.toggle('show'));
feedInfoBtn.addEventListener('click', ()=> feedInfo.classList.toggle('show'));

/* Sheet */
function openSheet(key, label, curVal, series){
  sheet.classList.add('show');
  sheetTitle.textContent = label;
  document.getElementById('curLabel').textContent = DATA.ui.detail.curLabel;
  document.getElementById('chgLabel').textContent = DATA.ui.detail.chgLabel;
  document.getElementById('defLabel').textContent = DATA.ui.detail.defLabel;
  document.getElementById('howLabel').textContent = DATA.ui.detail.howLabel;
  document.getElementById('imprLabel').textContent = DATA.ui.detail.imprLabel;

  sheetCur.textContent = fmt(curVal);
  const t = trendPct(series);
  sheetDelta.textContent = (t>=0?'▲ ':'▼ ') + Math.abs(t) + '%';
  sheetDelta.style.color = t>=0 ? '#34d399' : '#f87171';

  // пояснения
  sheetDef.textContent  = DATA.ui.metricExplain[key].what;
  sheetHow.textContent  = DATA.ui.metricExplain[key].how;
  sheetImpr.textContent = DATA.ui.metricExplain[key].improve;

  // график с осями
  drawDetailChart(detailSvg, series, DATA.ui.detail.axisX, DATA.ui.metricExplain[key].unitY);
  detailAxesNote.textContent = DATA.ui.detail.axesNote
    .replace('{x}', DATA.ui.detail.axisX)
    .replace('{y}', DATA.ui.metricExplain[key].unitY);
}
document.querySelector('#sheet .bg').addEventListener('click', ()=> sheet.classList.remove('show'));
closeSheet.addEventListener('click', ()=> sheet.classList.remove('show'));

/* CSV & Share */
document.getElementById('exportCsv').addEventListener('click', ()=>{
  if(!DATA) return; const d = DATA[PERIOD];
  const rows = [['метрика','значение'], ...DATA.kpis.map(k => [k.label, d[k.key]])];
  const csv = rows.map(r=>r.join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download=`метрики_${PERIOD}.csv`; a.click(); URL.revokeObjectURL(url);
});
document.getElementById('shareBtn').addEventListener('click', ()=>{
  const d = DATA[PERIOD];
  const text = DATA.ui.shareTemplate
    .replace('{period}', DATA.ui.periodNames[PERIOD])
    .replace('{sent}', fmt(d.sent)).replace('{opened}', fmt(d.opened)).replace('{replies}', fmt(d.replies)).replace('{errors}', fmt(d.errors));
  if (navigator.share) { navigator.share({text}).catch(()=>{}); } else { alert(text); }
});

/* Helpers: charts */
function makeFade(id, color){
  const g = document.createElementNS('http://www.w3.org/2000/svg','linearGradient');
  g.setAttribute('id',id); g.setAttribute('x1','0'); g.setAttribute('x2','0'); g.setAttribute('y1','0'); g.setAttribute('y2','1');
  const s1 = document.createElementNS('http://www.w3.org/2000/svg','stop'); s1.setAttribute('offset','0%'); s1.setAttribute('stop-color',color); s1.setAttribute('stop-opacity','0.35'); g.appendChild(s1);
  const s2 = document.createElementNS('http://www.w3.org/2000/svg','stop'); s2.setAttribute('offset','100%'); s2.setAttribute('stop-color',color); s2.setAttribute('stop-opacity','0.02'); g.appendChild(s2);
  return g;
}
function buildPath(arr,w,h,p,maxY){
  return arr.map((y,i)=>{
    const x = p + (i * (w - p*2)) / (arr.length - 1);
    const yy = h - p - (y / maxY) * (h - p*2);
    return (i===0?'M':'L') + x + ',' + yy;
  }).join(' ');
}
function svgPath(d, stroke, sw){
  const el=document.createElementNS('http://www.w3.org/2000/svg','path');
  el.setAttribute('d',d); el.setAttribute('stroke',stroke); el.setAttribute('stroke-width',sw); el.setAttribute('fill','none');
  return el;
}
function drawSparkline(svg, arr, color){
  while(svg.firstChild) svg.removeChild(svg.firstChild);
  const w=160,h=28,p=2;
  const max = Math.max(...arr) || 1;
  const min = Math.min(...arr) || 0;
  const span = Math.max(max - min, 1);
  const d = arr.map((v,i)=>{
    const x = p + (i * (w - p*2))/(arr.length-1);
    const y = h - p - ((v - min)/span) * (h - p*2);
    return (i===0?'M':'L') + x + ',' + y;
  }).join(' ');
  const defs = document.createElementNS('http://www.w3.org/2000/svg','defs');
  const gid = 'sp' + Math.random().toString(36).slice(2);
  const grad = makeFade(gid, color); grad.setAttribute('id', gid);
  defs.appendChild(grad); svg.appendChild(defs);
  const area = document.createElementNS('http://www.w3.org/2000/svg','path');
  area.setAttribute('d', d + ` L ${w-p},${h-p} L ${p},${h-p} Z`);
  area.setAttribute('fill', `url(#${gid})`);
  svg.appendChild(area);
  const path = svgPath(d, color, 1.6);
  svg.appendChild(path);
}
function drawDetailChart(svg, arr, axisXLabel, axisYLabel){
  while(svg.firstChild) svg.removeChild(svg.firstChild);
  const w=340, h=160, p=28; // больше отступы под оси
  svg.setAttribute('viewBox', `0 0 ${w} ${h}`);
  svg.setAttribute('width', '100%'); svg.setAttribute('height', h);

  const max = Math.max(...arr) || 1;
  const min = Math.min(...arr) || 0;
  const span = Math.max(max-min, 1);

  // оси
  const axisColor='rgba(255,255,255,0.4)';
  const axX = document.createElementNS('http://www.w3.org/2000/svg','line');
  axX.setAttribute('x1', p); axX.setAttribute('y1', h-p); axX.setAttribute('x2', w-p); axX.setAttribute('y2', h-p); axX.setAttribute('stroke',axisColor);
  const axY = document.createElementNS('http://www.w3.org/2000/svg','line');
  axY.setAttribute('x1', p); axY.setAttribute('y1', p); axY.setAttribute('x2', p); axY.setAttribute('y2', h-p); axY.setAttribute('stroke',axisColor);
  svg.append(axX, axY);

  // тики Y
  for(let i=0;i<=3;i++){
    const y = p + i*((h - p*2)/3); const val = Math.round(max - (i*span/3));
    const ln = document.createElementNS('http://www.w3.org/2000/svg','line');
    ln.setAttribute('x1', p); ln.setAttribute('x2', w-p); ln.setAttribute('y1', y); ln.setAttribute('y2', y);
    ln.setAttribute('stroke','rgba(255,255,255,0.09)'); svg.appendChild(ln);
    const t = textElem({x:String(p-6), y:String(y+4), 'text-anchor':'end', fill:'#9aa0ad'}, String(val)); t.style.fontSize='10px'; svg.appendChild(t);
  }
  // тики X
  for(let i=0;i<arr.length;i++){
    const x = p + (i * (w - p*2)) / (arr.length - 1);
    if (i%Math.ceil(arr.length/6)===0){
      const t = textElem({x:String(x), y:String(h-p+14), 'text-anchor':'middle', fill:'#9aa0ad'}, String(i+1)); t.style.fontSize='10px'; svg.appendChild(t);
    }
  }
  // подписи осей
  const xLabel = textElem({x:String(w/2), y:String(h-6), 'text-anchor':'middle', fill:'#9aa0ad'}, axisXLabel); xLabel.style.fontSize='11px';
  const yLabel = textElem({x:'6', y:String(h/2), 'text-anchor':'middle', fill:'#9aa0ad', transform:`rotate(-90 6 ${h/2})`}, axisYLabel); yLabel.style.fontSize='11px';
  svg.append(xLabel, yLabel);

  // линия + подложка
  const pathD = arr.map((v,i)=>{
    const x = p + (i * (w - p*2)) / (arr.length - 1);
    const y = h - p - ((v - min)/span) * (h - p*2);
    return (i===0?'M':'L') + x + ',' + y;
  }).join(' ');
  const defs = document.createElementNS('http://www.w3.org/2000/svg','defs');
  defs.append(makeFade('detailFade', cssVar('--cyan'))); svg.appendChild(defs);
  const area = document.createElementNS('http://www.w3.org/2000/svg','path');
  area.setAttribute('d', pathD + ` L ${w-p},${h-p} L ${p},${h-p} Z`);
  area.setAttribute('fill','url(#detailFade)'); svg.appendChild(area);
  svg.append(svgPath(pathD, cssVar('--cyan'), 2));
}
</script>
</body>
</html>

