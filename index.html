<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>WandLead • Mini App</title> 
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  :root{
    --bg:#0b0c10;
    --fg:#e8e8f1;
    --muted:#9aa0ad;
    --line:rgba(255,255,255,0.12);
    --cyan:#67e8f9;
    --cyan-strong:#22d3ee;
    --violet:#a78bfa;
    --violet-strong:#7c3aed;
    --chip:linear-gradient(135deg,#00e5ff 0%, #7c3aed 100%);
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,'Helvetica Neue',Arial;}
  *{box-sizing:border-box;letter-spacing:.01em}
  .container{max-width:960px;margin:0 auto;padding:12px 12px 72px;}
  .bar{position:sticky;top:0;z-index:5;background:rgba(11,12,16,.85);backdrop-filter:blur(8px);border-bottom:1px solid var(--line)}
  .bar-inner{max-width:960px;margin:0 auto;padding:8px 12px;display:flex;align-items:center;justify-content:space-between;gap:8px;color:var(--fg)}
  .brand{display:flex;align-items:center;gap:8px;color:var(--fg)}
  .dot{width:20px;height:20px;border-radius:6px;background:linear-gradient(135deg,#00e5ff 0%,#7c3aed 100%);}
  .tabs,.period{display:flex;gap:8px}
  .btn{border:1px solid var(--line);background:rgba(255,255,255,0.03);color:var(--fg);padding:8px 10px;border-radius:10px;font-size:12px}
  .btn:hover{background:rgba(255,255,255,0.06)}
  .btn.active{background:rgba(255,255,255,0.08);color:var(--fg);border-color:var(--line)}
  .btn-chip.active{background:var(--chip);color:#fff;border-color:#0000}
  .grid{display:grid;gap:12px}
  .g2{grid-template-columns:repeat(2,minmax(0,1fr))}
  .g3{grid-template-columns:repeat(3,minmax(0,1fr))}
  @media (max-width:720px){.g2{grid-template-columns:1fr}.g3{grid-template-columns:1fr}}
  .card{border:1px solid var(--line);border-radius:14px;background:rgba(255,255,255,0.02);padding:12px;color:var(--fg)}
  .label{font-size:10px;text-transform:uppercase;letter-spacing:.08em;color:var(--muted)}
  .kpi{display:flex;align-items:flex-end;justify-content:space-between;margin-top:4px}
  .kpi .val{font-size:24px;font-weight:700;tabular-nums:tabular-nums;color:var(--fg)}
  .delta{font-size:11px;border:1px solid;color:#fff;padding:2px 6px;border-radius:8px}
  .delta.pos{border-color:#34d399;color:#34d399}
  .delta.neg{border-color:#f87171;color:#f87171}
  .spark{width:100%;height:34px;margin-top:6px}
  .section-title{display:flex;align-items:center;justify-content:space-between;margin:8px 0;color:var(--fg)}
  .subtitle{font-size:12px;color:var(--muted)}
  .footer{position:fixed;left:0;right:0;bottom:0;border-top:1px solid var(--line);background:rgba(11,12,16,.9);backdrop-filter:blur(8px)}
  .footer-inner{max-width:960px;margin:0 auto;padding:8px 12px;display:flex;align-items:center;justify-content:space-between;color:var(--muted);font-size:12px}
  .row{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;border-bottom:1px solid rgba(255,255,255,.06);color:var(--fg)}
  .row:last-child{border-bottom:0}
  .badge{font-size:11px;border:1px solid var(--line);border-radius:8px;padding:3px 8px;color:var(--fg)}
  .hint{color:var(--muted);font-size:12px}
  .sheet{position:fixed;inset:0;z-index:20;display:none}
  .sheet.show{display:block}
  .sheet .bg{position:absolute;inset:0;background:#0008}
  .sheet .panel{position:absolute;left:0;right:0;bottom:0;margin:0 auto;max-width:720px;background:var(--bg);border:1px solid var(--line);border-bottom:0;border-radius:16px 16px 0 0;padding:12px;color:var(--fg)}
</style>
</head>
<body>
  <!-- Top Bar -->
  <div class="bar">
    <div class="bar-inner">
      <div class="brand">
        <div class="dot"></div>
        <div style="font-weight:600">WandLead • Mini</div>
      </div>
      <div class="period" id="periodBtns">
        <button class="btn btn-chip active" data-period="today">День</button>
        <button class="btn btn-chip" data-period="week">Неделя</button>
        <button class="btn btn-chip" data-period="month">Месяц</button>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Tabs -->
    <div class="tabs" id="tabs">
      <button class="btn active" data-tab="overview">Обзор</button>
      <button class="btn" data-tab="sectors">Сферы</button>
      <button class="btn" data-tab="activity">Активность</button>
    </div>

    <!-- OVERVIEW -->
    <div id="tab-overview" class="grid" style="margin-top:12px">
      <!-- KPIs -->
      <div class="grid g2" id="kpis"></div>

      <!-- Line Chart -->
      <div class="card">
        <div class="section-title">
          <div>Динамика (Открытия • Ответы)</div>
          <div class="subtitle" id="lineSubtitle">по дням</div>
        </div>
        <svg id="lineChart" viewBox="0 0 720 220" width="100%" height="220"></svg>
        <svg id="lineChart" viewBox="0 0 720 220" width="100%" height="220"></svg>
        <div id="lineTip" class="hint" style="margin-top:6px">Наведите/тапните по графику</div>

        <div class="hint" style="margin-top:6px">Наведи/тапни по графику — появится вертикальный гид.</div>
      </div>

      <!-- Funnel + Donut -->
      <div class="grid g3">
        <div class="card" style="grid-column:span 2;">
          <div class="section-title">
            <div>Воронка</div><div class="subtitle">Sent → Opened → Replies</div>
          </div>
          <div id="funnel" class="grid g3"></div>
        </div>
        <div class="card">
          <div class="section-title"><div>Качество</div><div class="subtitle" id="donutSub"></div></div>
          <svg id="donut" viewBox="0 0 140 140" width="100%" height="140"></svg>
        </div>
      </div>
    </div>

    <!-- SECTORS -->
    <div id="tab-sectors" class="grid" style="display:none;margin-top:12px">
      <div class="section-title">
        <div>Сферы: эффективность</div>
        <div class="tabs">
          <button class="btn active" id="sortReplies">По ответам</button>
          <button class="btn" id="sortOpen">По открытиям</button>
        </div>
      </div>
      <div id="sectorsList" class="grid g2"></div>
    </div>

    <!-- ACTIVITY -->
    <div id="tab-activity" style="display:none;margin-top:12px">
      <div class="card">
        <div class="section-title"><div>Лента активности</div><div class="subtitle" id="activityHint">за период</div></div>
        <div id="feed"></div>
      </div>
    </div>
  </div>

  <!-- KPI DETAIL SHEET -->
  <div id="sheet" class="sheet" aria-hidden="true">
    <div class="bg"></div>
    <div class="panel">
      <div class="section-title"><div class="label">Детали метрики</div><button class="btn" id="closeSheet">Закрыть</button></div>
      <div id="sheetTitle" style="font-weight:600;font-size:18px"></div>
      <svg id="sheetSpark" class="spark" viewBox="0 0 160 42" width="100%" height="42"></svg>
      <div class="grid g2" style="margin-top:8px">
        <div class="card"><div class="label">Текущий</div><div id="sheetCur" style="margin-top:4px;font-size:14px;color:#34d399"></div></div>
        <div class="card"><div class="label">Изм. к периоду</div><div id="sheetDelta" style="margin-top:4px;font-size:14px"></div></div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <div class="footer">
    <div class="footer-inner">
      <div class="hint">© 2025 WandLead</div>
      <div class="tabs">
        <button class="btn" id="exportCsv">Экспорт CSV</button>
        <button class="btn" id="shareBtn">Поделиться</button>
      </div>
    </div>
  </div>

<script>
/* Telegram init */
(function(){
  if (window.Telegram && Telegram.WebApp) {
    try { Telegram.WebApp.ready(); Telegram.WebApp.expand(); } catch(e){}
  }
})();

const fmt = (n)=> n.toLocaleString('ru-RU');
const clamp = (x,a,b)=> Math.max(a, Math.min(b, x));
function trendPct(arr){ if(!arr||arr.length<2) return 0; const a=arr[0], b=arr[arr.length-1]; return a?Math.round(((b-a)/a)*100):0; }

let DATA=null, PERIOD='today', SORT='replies', ACTIVE_TAB='overview';

const periodBtns = document.getElementById('periodBtns');
const tabs = document.getElementById('tabs');
const kpisBox = document.getElementById('kpis');
const lineSvg = document.getElementById('lineChart');
const lineSubtitle = document.getElementById('lineSubtitle');
const funnelBox = document.getElementById('funnel');
const donutSvg = document.getElementById('donut');
const donutSub = document.getElementById('donutSub');
const sectorsList = document.getElementById('sectorsList');
const sortReplies = document.getElementById('sortReplies');
const sortOpen = document.getElementById('sortOpen');
const feed = document.getElementById('feed');
const activityHint = document.getElementById('activityHint');
const sheet = document.getElementById('sheet');
const closeSheet = document.getElementById('closeSheet');
const sheetTitle = document.getElementById('sheetTitle');
const sheetCur = document.getElementById('sheetCur');
const sheetDelta = document.getElementById('sheetDelta');
const sheetSpark = document.getElementById('sheetSpark');

const tabOverview = document.getElementById('tab-overview');
const tabSectors = document.getElementById('tab-sectors');
const tabActivity = document.getElementById('tab-activity');

document.getElementById('exportCsv').addEventListener('click', exportCsv);
document.getElementById('shareBtn').addEventListener('click', shareState);

/* Load data ONLY from data.txt */
fetch('data.txt?ts='+Date.now())
  .then(r => r.text())
  .then(t => JSON.parse(t))
  .then(json => { DATA=json; renderAll(); })
  .catch(err => { console.error(err); alert('Ошибка загрузки data.txt'); });

function renderAll(){
  const d = DATA[PERIOD];
  renderKPIs(d);
  renderLine(d);
  renderFunnel(d);
  renderDonut(d);
  renderSectors();
  renderFeed(d);
  lineSubtitle.textContent = (PERIOD==='today'?'по часам':'по дням');
  activityHint.textContent = (PERIOD==='today'?'за день':PERIOD==='week'?'за неделю':'за месяц');
}

function renderKPIs(d){
  kpisBox.innerHTML = '';
  const list = DATA.kpis; // порядок и ключи из файла
  list.forEach(k=>{
    const delta = d.delta[k.key] ?? 0;
    const spark = d.spark[k.key] || [];
    const card = document.createElement('button');
    card.className='card'; card.style.textAlign='left';
    card.addEventListener('click',()=>openSheet(k.label, d[k.key], spark));

    const top = document.createElement('div'); top.className='label'; top.textContent=k.label;

    const kpi = document.createElement('div'); kpi.className='kpi';
    const val = document.createElement('div'); val.className='val'; val.textContent=fmt(d[k.key]||0);
    const del = document.createElement('div'); del.className='delta '+(delta>=0?'pos':'neg'); del.textContent=(delta>=0?'▲ ':'▼ ')+Math.abs(delta)+'%';
    kpi.append(val, del);

    const sparkSvg = document.createElementNS('http://www.w3.org/2000/svg','svg');
    sparkSvg.setAttribute('viewBox','0 0 160 34'); sparkSvg.setAttribute('width','100%'); sparkSvg.setAttribute('height','34'); sparkSvg.classList.add('spark');
    drawSparkline(sparkSvg, spark, '#6ee7f3');

    card.append(top, kpi, sparkSvg);
    kpisBox.appendChild(card);
  });
}

function renderLine(d){
  const w=720,h=220,p=16;
  while(lineSvg.firstChild) lineSvg.removeChild(lineSvg.firstChild);

  // defs for fading areas
  const defs = document.createElementNS('http://www.w3.org/2000/svg','defs');
  const g1 = document.createElementNS('http://www.w3.org/2000/svg','linearGradient');
  g1.setAttribute('id','cyanFade'); g1.setAttribute('x1','0'); g1.setAttribute('x2','0'); g1.setAttribute('y1','0'); g1.setAttribute('y2','1');
  let s1 = document.createElementNS('http://www.w3.org/2000/svg','stop'); s1.setAttribute('offset','0%'); s1.setAttribute('stop-color','var(--cyan)'); s1.setAttribute('stop-opacity','0.35'); g1.appendChild(s1);
  s1 = document.createElementNS('http://www.w3.org/2000/svg','stop'); s1.setAttribute('offset','100%'); s1.setAttribute('stop-color','var(--cyan)'); s1.setAttribute('stop-opacity','0.02'); g1.appendChild(s1);

  const g2 = document.createElementNS('http://www.w3.org/2000/svg','linearGradient');
  g2.setAttribute('id','violetFade'); g2.setAttribute('x1','0'); g2.setAttribute('x2','0'); g2.setAttribute('y1','0'); g2.setAttribute('y2','1');
  let s2 = document.createElementNS('http://www.w3.org/2000/svg','stop'); s2.setAttribute('offset','0%'); s2.setAttribute('stop-color','var(--violet)'); s2.setAttribute('stop-opacity','0.35'); g2.appendChild(s2);
  s2 = document.createElementNS('http://www.w3.org/2000/svg','stop'); s2.setAttribute('offset','100%'); s2.setAttribute('stop-color','var(--violet)'); s2.setAttribute('stop-opacity','0.02'); g2.appendChild(s2);
  defs.append(g1,g2);
  lineSvg.appendChild(defs);

  const gridColor='rgba(255,255,255,0.06)';
  for(let i=0;i<4;i++){
    const y=p + i*((h-p*2)/3);
    const ln = document.createElementNS('http://www.w3.org/2000/svg','line');
    ln.setAttribute('x1',p); ln.setAttribute('x2',w-p); ln.setAttribute('y1',y); ln.setAttribute('y2',y);
    ln.setAttribute('stroke',gridColor); lineSvg.appendChild(ln);
  }

  const maxY = Math.max(...d.byDay, ...d.repliesByDay) * 1.15;
  const pathOpen = buildPath(d.byDay, w, h, p, maxY);
  const pathReply = buildPath(d.repliesByDay, w, h, p, maxY);

  // Areas (fading)
  const areaOpen = document.createElementNS('http://www.w3.org/2000/svg','path');
  areaOpen.setAttribute('d', pathOpen + ` L ${w-p},${h-p} L ${p},${h-p} Z`);
  areaOpen.setAttribute('fill','url(#cyanFade)');
  const areaReply = document.createElementNS('http://www.w3.org/2000/svg','path');
  areaReply.setAttribute('d', pathReply + ` L ${w-p},${h-p} L ${p},${h-p} Z`);
  areaReply.setAttribute('fill','url(#violetFade)');
  lineSvg.append(areaOpen, areaReply);

  // Lines
  const p1 = svgPath(pathOpen, getComputedStyle(document.documentElement).getPropertyValue('--cyan'), 2.2);
  const p2 = svgPath(pathReply, getComputedStyle(document.documentElement).getPropertyValue('--violet'), 2.2);
  lineSvg.append(p1, p2);

  // hover guide
  const guide = document.createElementNS('http://www.w3.org/2000/svg','line');
  guide.setAttribute('y1', p); guide.setAttribute('y2', h-p);
  guide.setAttribute('stroke','rgba(255,255,255,0.25)'); guide.style.display='none';
  lineSvg.appendChild(guide);

  lineSvg.onmousemove = (e)=>{
    const rect = lineSvg.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const i = Math.round(((x - p) / (w - p*2)) * (d.byDay.length - 1));
    if (i>=0 && i<d.byDay.length){
      const cx = p + (i * (w - p*2)) / (d.byDay.length - 1);
      guide.setAttribute('x1', cx); guide.setAttribute('x2', cx);
      guide.style.display='block';
    }
  };
  lineSvg.onmouseleave = ()=> guide.style.display='none';
}

function buildPath(arr,w,h,p,maxY){
  return arr.map((y,i)=>{
    const x = p + (i * (w - p*2)) / (arr.length - 1);
    const yy = h - p - (y / maxY) * (h - p*2);
    return (i===0?'M':'L') + x + ',' + yy;
  }).join(' ');
}
function svgPath(d, stroke, sw){
  const el=document.createElementNS('http://www.w3.org/2000/svg','path');
  el.setAttribute('d',d); el.setAttribute('stroke',stroke); el.setAttribute('stroke-width',sw); el.setAttribute('fill','none');
  return el;
}
function drawSparkline(svg, arr, color){
  while(svg.firstChild) svg.removeChild(svg.firstChild);
  const w=160,h=34,p=2;
  const max = Math.max(...arr) || 1;
  const min = Math.min(...arr) || 0;
  const span = Math.max(max - min, 1);
  const d = arr.map((v,i)=>{
    const x = p + (i * (w - p*2))/(arr.length-1);
    const y = h - p - ((v - min)/span) * (h - p*2);
    return (i===0?'M':'L') + x + ',' + y;
  }).join(' ');
  // fading fill for spark
  const defs = document.createElementNS('http://www.w3.org/2000/svg','defs');
  const gid = 'sp' + Math.random().toString(36).slice(2);
  const g = document.createElementNS('http://www.w3.org/2000/svg','linearGradient');
  g.setAttribute('id',gid); g.setAttribute('x1','0'); g.setAttribute('x2','0'); g.setAttribute('y1','0'); g.setAttribute('y2','1');
  let s = document.createElementNS('http://www.w3.org/2000/svg','stop'); s.setAttribute('offset','0%'); s.setAttribute('stop-color',color); s.setAttribute('stop-opacity','0.35'); g.appendChild(s);
  s = document.createElementNS('http://www.w3.org/2000/svg','stop'); s.setAttribute('offset','100%'); s.setAttribute('stop-color',color); s.setAttribute('stop-opacity','0.02'); g.appendChild(s);
  defs.appendChild(g); svg.appendChild(defs);
  const area = document.createElementNS('http://www.w3.org/2000/svg','path');
  area.setAttribute('d', d + ` L ${w-p},${h-p} L ${p},${h-p} Z`);
  area.setAttribute('fill', `url(#${gid})`);
  svg.appendChild(area);
  const path = svgPath(d, color, 1.8);
  svg.appendChild(path);
}

function renderFunnel(d){
  funnelBox.innerHTML = '';
  const steps = DATA.funnelOrder.map(key => ({label: DATA.labels[key] || key, val: d[key]}));
  const max = Math.max(...steps.map(s=>s.val));
  steps.forEach(s=>{
    const card = document.createElement('div'); card.className='card';
    const lb = document.createElement('div'); lb.className='label'; lb.textContent=s.label;
    const bar = document.createElement('div'); bar.style.cssText='margin-top:8px;height:10px;border-radius:8px;background:rgba(255,255,255,0.06);overflow:hidden';
    const fill = document.createElement('div'); fill.style.cssText='height:100%;background:linear-gradient(90deg,#00e5ff,#7c3aed)';
    fill.style.width = Math.max(6, (s.val/max)*100) + '%';
    bar.appendChild(fill);
    const v = document.createElement('div'); v.style.cssText='margin-top:4px;font-size:13px'; v.textContent = fmt(s.val);
    card.append(lb, bar, v);
    funnelBox.appendChild(card);
  });
}

function renderDonut(d){
  const total = Math.max(d.sent, 1);
  const errPct = clamp((d.errors/total)*100, 0, 100);
  donutSub.textContent = `Ошибки ${Math.round(errPct)}%`;
  while(donutSvg.firstChild) donutSvg.removeChild(donutSvg.firstChild);
  const cx=70, cy=70, r=46, circ=2*Math.PI*r;

  const base = document.createElementNS('http://www.w3.org/2000/svg','circle');
  base.setAttribute('cx',cx); base.setAttribute('cy',cy); base.setAttribute('r',r);
  base.setAttribute('stroke','rgba(255,255,255,0.08)'); base.setAttribute('stroke-width','14'); base.setAttribute('fill','none');

  const ring = document.createElementNS('http://www.w3.org/2000/svg','circle');
  ring.setAttribute('cx',cx); ring.setAttribute('cy',cy); ring.setAttribute('r',r);
  ring.setAttribute('stroke','#1f2937'); ring.setAttribute('stroke-width','14'); ring.setAttribute('fill','none');
  ring.setAttribute('transform','rotate(-90 70 70)');

  const err = document.createElementNS('http://www.w3.org/2000/svg','circle');
  err.setAttribute('cx',cx); err.setAttribute('cy',cy); err.setAttribute('r',r);
  err.setAttribute('stroke','#ef4444'); err.setAttribute('stroke-width','14'); err.setAttribute('fill','none');
  err.setAttribute('stroke-linecap','round'); err.setAttribute('transform','rotate(-90 70 70)');
  const errLen = (errPct/100)*circ;
  err.setAttribute('stroke-dasharray', `${errLen} ${circ - errLen}`);

  const txt = document.createElementNS('http://www.w3.org/2000/svg','text');
  txt.setAttribute('x','50%'); txt.setAttribute('y','50%');
  txt.setAttribute('dominant-baseline','middle'); txt.setAttribute('text-anchor','middle');
  txt.style.fontSize='18px'; txt.style.fontWeight='700'; txt.setAttribute('fill','#ffffff');
  txt.textContent = (100 - errPct).toFixed(0) + '%';

  donutSvg.append(base, ring, err, txt);
}

function renderSectors(){
  const list = (DATA[PERIOD].sectors||[]).slice();
  list.sort((a,b)=> (SORT==='replies' ? b.reply - a.reply : b.open - a.open));
  sectorsList.innerHTML='';
  list.forEach(s=>{
    const card = document.createElement('div'); card.className='card';
    const head = document.createElement('div'); head.className='row'; head.style.padding='0'; head.style.border='0';
    const name = document.createElement('div'); name.style.fontWeight='600'; name.textContent=s.name;
    const trend = document.createElement('div'); trend.className='badge';
    trend.style.color = s.trend>0?'#34d399': s.trend<0?'#f87171':'var(--fg)';
    trend.textContent = (s.trend>0?'▲ ':'') + (s.trend<0?'▼ ':'') + Math.abs(s.trend) + '%';
    head.append(name, trend);

    const meta = document.createElement('div'); meta.className='hint'; meta.textContent = 'Писем: ' + fmt(s.sent);

    const grid = document.createElement('div'); grid.className='grid g2';
    const c1 = document.createElement('div'); c1.className='card'; c1.innerHTML = `<div class="label">Открытия</div><div style="margin-top:4px"><b>${s.open}%</b></div>`;
    const c2 = document.createElement('div'); c2.className='card'; c2.innerHTML = `<div class="label">Ответы</div><div style="margin-top:4px"><b>${s.reply}%</b></div>`;

    grid.append(c1,c2);
    card.append(head, meta, grid);
    sectorsList.appendChild(card);
  });
}

function renderFeed(d){
  feed.innerHTML='';
  const items = DATA.feedTemplate.map(t => {
    // подставляем значения метрик в шаблон
    const text = t.text
      .replace('{sent}', fmt(d.sent))
      .replace('{opened}', fmt(d.opened))
      .replace('{replies}', fmt(d.replies))
      .replace('{errors}', fmt(d.errors));
    return { type:t.type, title:text, time:t.time };
  });
  items.forEach(row=>{
    const r = document.createElement('div'); r.className='row';
    const left = document.createElement('div'); left.style.display='flex'; left.style.alignItems='center'; left.style.gap='8px';
    const dot = document.createElement('div'); dot.style.width='10px'; dot.style.height='10px'; dot.style.borderRadius='50%';
    dot.style.background = row.type==='reply'? '#34d399' : row.type==='open' ? 'var(--cyan)' : row.type==='error' ? '#f87171' : '#9ca3af';
    const ttl = document.createElement('div'); ttl.textContent = row.title;
    left.append(dot, ttl);
    const time = document.createElement('div'); time.className='hint'; time.textContent=row.time;
    r.append(left, time); feed.appendChild(r);
  });
}

periodBtns.addEventListener('click', (e)=>{
  const b = e.target.closest('button'); if(!b) return;
  PERIOD = b.dataset.period;
  [...periodBtns.querySelectorAll('button')].forEach(x=>x.classList.remove('active'));
  b.classList.add('active');
  renderAll();
});
tabs.addEventListener('click', (e)=>{
  const b = e.target.closest('button'); if(!b) return;
  const tab = b.dataset.tab;
  ACTIVE_TAB = tab;
  [...tabs.querySelectorAll('button')].forEach(x=>x.classList.remove('active'));
  b.classList.add('active');
  tabOverview.style.display = tab==='overview'?'grid':'none';
  tabSectors.style.display = tab==='sectors'?'grid':'none';
  tabActivity.style.display = tab==='activity'?'block':'none';
});
sortReplies.addEventListener('click', ()=>{ SORT='replies'; sortReplies.classList.add('active'); sortOpen.classList.remove('active'); renderSectors(); });
sortOpen.addEventListener('click', ()=>{ SORT='open'; sortOpen.classList.add('active'); sortReplies.classList.remove('active'); renderSectors(); });

function openSheet(title, curVal, sparkArr){
  sheet.classList.add('show');
  sheetTitle.textContent = title;
  sheetCur.textContent = fmt(curVal);
  const t = trendPct(sparkArr);
  sheetDelta.textContent = (t>=0?'▲ ':'▼ ') + Math.abs(t) + '%';
  sheetDelta.style.color = t>=0 ? '#34d399' : '#f87171';
  drawSparkline(sheetSpark, sparkArr, t>=0 ? '#34d399' : '#f87171');
}
document.querySelector('#sheet .bg').addEventListener('click', ()=> sheet.classList.remove('show'));
closeSheet.addEventListener('click', ()=> sheet.classList.remove('show'));

function exportCsv(){
  if(!DATA) return;
  const d = DATA[PERIOD];
  const rows = [
    ['metric','value'],
    ...DATA.kpis.map(k => [k.key, d[k.key]])
  ];
  const csv = rows.map(r=>r.join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download=`metrics_${PERIOD}.csv`; a.click();
  URL.revokeObjectURL(url);
}
function shareState(){
  const d = DATA[PERIOD];
  const text = `WandLead: период=${PERIOD}, отправлено=${d.sent}, ответы=${d.replies}`;
  if (navigator.share) { navigator.share({text}).catch(()=>{}); } else { alert(text); }
}
</script>
</body>
</html>
