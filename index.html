
<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ЛК клиента — Email кампании</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg: #0b0e13;
      --card: #121723;
      --muted: #9aa4b2;
      --text: #e6ecf2;
      --primary: #7c9aff;
      --accent: #72e0a8;
      --danger: #ff6b6b;
      --warning: #ffd166;
      --surface: #0f1420;
      --border: #1f2737;
      --good: #27d980;
      --bad: #ff5d5d;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
    header{position:sticky;top:0;background:linear-gradient(180deg,#0b0e13,rgba(11,14,19,.7));backdrop-filter: blur(6px);z-index:50;border-bottom:1px solid var(--border)}
    .wrap{max-width:1200px;margin:0 auto;padding:24px}
    .title{font-size:28px;font-weight:800;letter-spacing:.3px}
    .tabs{display:flex;gap:8px;margin-top:16px}
    .tab{padding:10px 14px;border:1px solid var(--border);border-radius:10px;background:var(--surface);cursor:pointer;font-weight:600;color:var(--muted)}
    .tab.active{color:var(--text);border-color:#2c354a;box-shadow:0 0 0 1px rgba(124,154,255,.2) inset}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .card{grid-column:span 3;background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;position:relative;overflow:hidden}
    .card:hover{border-color:#2f3a54}
    .card h3{margin:0 0 6px 0;font-size:14px;color:var(--muted);font-weight:600;display:flex;align-items:center;gap:8px}
    .value{font-size:26px;font-weight:800;margin:2px 0 10px}
    .btn{padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:var(--surface);cursor:pointer;color:var(--text);font-weight:600}
    .btn:hover{border-color:#40507a}
    .muted{color:var(--muted);font-size:13px}
    .chart-mini{height:80px}
    .row-12{grid-column:span 12}
    .row-6{grid-column:span 6}
    .kpi{display:flex;gap:12px;flex-wrap:wrap}
    .kpi span{padding:6px 10px;border:1px solid var(--border);border-radius:10px;background:var(--surface);font-size:12px;color:var(--muted)}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;background:#0f1828;border:1px solid #1d2840;font-size:12px}
    .i{width:18px;height:18px;display:inline-flex;align-items:center;justify-content:center;border:1px solid var(--border);border-radius:50%;cursor:pointer}
    .i:hover{border-color:#5b6b92}
    .legend{display:flex;gap:12px;font-size:12px;color:var(--muted)}
    .legend .dot{width:10px;height:10px;border-radius:50%}
    /* modal */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);padding:20px;z-index:99}
    .modal.open{display:flex}
    .modal .inner{width:min(980px,96vw);background:var(--card);border:1px solid var(--border);border-radius:16px;padding:20px}
    .modal .head{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .modal .head h2{margin:0;font-size:20px}
    .close{cursor:pointer;border:1px solid var(--border);padding:6px 10px;border-radius:8px;background:var(--surface)}
    .two-col{display:grid;grid-template-columns:1.2fr .8fr;gap:16px}
    .stat{display:flex;flex-direction:column;gap:8px}
    .stat .big{font-size:32px;font-weight:800}
    @media (max-width: 900px){
      .card{grid-column:span 6}
      .two-col{grid-template-columns:1fr}
    }
    @media (max-width: 600px){
      .card{grid-column:span 12}
    }
    /* table for spheres */
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left;font-size:14px}
    th{color:var(--muted);font-weight:600}
    .up{color:var(--good);font-weight:700}
    .down{color:var(--bad);font-weight:700}
    .pill{padding:4px 8px;border-radius:8px;background:var(--surface);border:1px solid var(--border);font-size:12px}
    footer{opacity:.7;font-size:12px;padding:24px;text-align:center}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="title">WandLead — кабинет клиента</div>
      <div class="tabs">
        <button class="tab active" data-tab="overview">Обзор</button>
        <button class="tab" data-tab="spheres">Сферы</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section id="overview" class="tabpane">
      <div class="grid" id="kpi-grid">
        <!-- KPI cards injected here -->
      </div>

      <div class="grid" style="margin-top:10px">
        <div class="card row-12">
          <h3>График динамики — Открытия и Ответы
            <span class="i" data-info-key="opens_replies">i</span>
          </h3>
          <div class="legend">
            <div><span class="dot" id="dot-open"></span> Открытия</div>
            <div><span class="dot" id="dot-reply"></span> Ответы</div>
          </div>
          <canvas id="comboChart" height="120"></canvas>
        </div>
      </div>

      <div class="grid" style="margin-top:10px">
        <div class="card row-6">
          <h3>Воронка <span class="i" data-info-key="funnel">i</span></h3>
          <div id="funnel" class="kpi"></div>
        </div>
        <div class="card row-6">
          <h3>Качество доставки <span class="i" data-info-key="delivery_quality">i</span></h3>
          <div class="stat">
            <div id="quality" class="big">—</div>
            <div class="muted" id="qualityCaption"></div>
          </div>
        </div>
      </div>
    </section>

    <section id="spheres" class="tabpane" style="display:none">
      <div class="card row-12">
        <h3>Сферы и эффективность <span class="i" data-info-key="spheres">i</span></h3>
        <div class="muted" id="avgLine"></div>
        <div style="overflow:auto;margin-top:10px">
          <table id="spheresTable">
            <thead>
              <tr>
                <th>Сфера</th>
                <th>Отправлено</th>
                <th>% открытий</th>
                <th>% ответов</th>
                <th>Эффективность vs среднее</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <div class="modal" id="metricModal">
    <div class="inner">
      <div class="head">
        <h2 id="modalTitle">Метрика</h2>
        <button class="close" id="closeModal">Закрыть</button>
      </div>
      <div class="two-col">
        <div>
          <canvas id="modalChart" height="180"></canvas>
        </div>
        <div class="stat">
          <div id="modalNow" class="big">—</div>
          <div id="modalForecast" class="pill">—</div>
          <div class="muted" id="modalLabels">—</div>
          <div class="muted" id="modalInfo">—</div>
        </div>
      </div>
    </div>
  </div>

  <footer>Обновлено: <span id="updatedAt">—</span></footer>

  <script>
  const state = { data: null, charts: {}, theme: { line: '#7c9aff', green:'#72e0a8', red:'#ff6b6b' } };
  const df = (n)=>n.toLocaleString('ru-RU');

  async function loadData(){
    const res = await fetch('data.txt?_=' + Date.now());
    const json = await res.json();
    state.data = json;
    document.getElementById('updatedAt').textContent = new Date(json.meta.updated_at).toLocaleString('ru-RU');
    buildKPI();
    buildCombo();
    buildFunnel();
    buildQuality();
    buildSpheres();
  }

  function gradient(ctx, color){
    const g = ctx.createLinearGradient(0,0,0,180);
    g.addColorStop(0, color + '90'); // ~56% opacity
    g.addColorStop(1, color + '00');
    return g;
  }

  function baseOptions(xLabel, yLabel){
    return {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      scales: {
        x: { grid: { color: '#1b2436' }, ticks: { color: '#8c97a6' }, title: { display:true, text:xLabel, color:'#8c97a6'} },
        y: { grid: { color: '#1b2436' }, ticks: { color: '#8c97a6' }, title: { display:true, text:yLabel, color:'#8c97a6'} }
      },
      plugins: {
        legend: { display:false },
        tooltip: { mode:'index', intersect:false, backgroundColor:'#0f1420', borderColor:'#2c354a', borderWidth:1, titleColor:'#e6ecf2', bodyColor:'#e6ecf2' }
      }
    };
  }

  function miniSpark(id, series){
    const ctx = document.getElementById(id).getContext('2d');
    const color = state.theme.line;
    const opt = baseOptions('', '');
    opt.scales.x.display=false; opt.scales.y.display=false;
    return new Chart(ctx, {
      type: 'line',
      data: { labels: state.data.timeseries.dates, datasets:[{ data: series, tension:.3, borderColor: color, fill:true, backgroundColor:(ctx)=>gradient(ctx.chart.ctx, '#7c9aff'), borderWidth:2, pointRadius:0 }] },
      options: opt
    });
  }

  function buildCard(key, title, color){
    const card = document.createElement('div');
    card.className='card';
    card.innerHTML = `
      <h3>${title} <span class="i" data-info-key="${key}">i</span></h3>
      <div class="value" id="${key}-value">—</div>
      <canvas class="chart-mini" id="${key}-chart"></canvas>
      <button class="btn" data-open="${key}">Открыть метрику</button>
    `;
    return card;
  }

  function buildKPI(){
    const grid = document.getElementById('kpi-grid');
    grid.innerHTML='';
    const defs = [
      ['sent','Отправлено писем'],
      ['delivered','Доставлено'],
      ['lpr_replies','Ответы ЛПР'],
      ['bounces','Ошибки доставки']
    ];
    defs.forEach(([key,title])=>{
      const card = buildCard(key,title);
      grid.appendChild(card);
      const series = state.data.timeseries[key];
      document.getElementById(`${key}-value`).textContent = df(state.data.blocks[key].current_total);
      state.charts[key] = miniSpark(`${key}-chart`, series);
    });

    grid.querySelectorAll('[data-open]').forEach(btn=>{
      btn.addEventListener('click', ()=>openModal(btn.dataset.open));
    });

    document.querySelectorAll('.i').forEach(el=>{
      el.addEventListener('click', ()=>{
        const k = el.dataset.infoKey;
        alert(state.data.info[k]);
      });
    });
  }

  function openModal(key){
    const modal = document.getElementById('metricModal');
    const cfg = state.data.blocks[key];
    const titleMap = {
      sent:'Отправлено писем', delivered:'Доставлено', lpr_replies:'Ответы ЛПР', bounces:'Ошибки доставки'
    };
    document.getElementById('modalTitle').textContent = titleMap[key] || key;
    document.getElementById('modalNow').textContent = 'Текущее значение: ' + df(cfg.current_total);
    document.getElementById('modalForecast').textContent = 'Прогноз на неделю при текущем темпе: ' + df(cfg.weekly_forecast);
    document.getElementById('modalLabels').textContent = cfg.axis_labels.y + ' / ' + cfg.axis_labels.x;
    document.getElementById('modalInfo').textContent = state.data.info[key] || '';

    if(state.charts.modal) state.charts.modal.destroy();
    const ctx = document.getElementById('modalChart').getContext('2d');
    const color = '#7c9aff';
    const options = baseOptions(cfg.axis_labels.x, cfg.axis_labels.y);
    state.charts.modal = new Chart(ctx, {
      type: 'line',
      data: { labels: state.data.timeseries.dates, datasets:[{
        label: titleMap[key],
        data: state.data.timeseries[key],
        borderColor: color,
        backgroundColor: (c)=>gradient(c.chart.ctx, '#7c9aff'),
        fill:true, tension:.35, borderWidth:2, pointRadius:0
      }]},
      options
    });

    modal.classList.add('open');
  }

  document.getElementById('closeModal').addEventListener('click',()=>document.getElementById('metricModal').classList.remove('open'));
  document.getElementById('metricModal').addEventListener('click',(e)=>{ if(e.target.id==='metricModal') e.currentTarget.classList.remove('open'); });

  function buildCombo(){
    const { dates, opens, replies } = state.data.timeseries;
    const ctx = document.getElementById('comboChart').getContext('2d');
    if(state.charts.combo) state.charts.combo.destroy();
    state.charts.combo = new Chart(ctx, {
      type:'line',
      data:{
        labels: dates,
        datasets:[
          { label:'Открытия', data: opens, borderColor:'#72e0a8', backgroundColor:(c)=>gradient(c.chart.ctx,'#72e0a8'), fill:true, tension:.35, pointRadius:0 },
          { label:'Ответы', data: replies, borderColor:'#7c9aff', backgroundColor:(c)=>gradient(c.chart.ctx,'#7c9aff'), fill:true, tension:.35, pointRadius:0 }
        ]
      },
      options: baseOptions(state.data.blocks.opens_replies.axis_labels.x, state.data.blocks.opens_replies.axis_labels.y)
    });
    document.getElementById('dot-open').style.background='#72e0a8';
    document.getElementById('dot-reply').style.background='#7c9aff';
  }

  function buildFunnel(){
    const f = state.data.funnel;
    const el = document.getElementById('funnel');
    el.innerHTML='';
    const steps = [
      ['Отправлено', f.sent],
      ['Открыто', f.opened],
      ['Ответ ЛПР', f.lpr_replies]
    ];
    steps.forEach(([name,val],i)=>{
      const rate = i===0 ? 1 : (val/steps[i-1][1]);
      const pill = document.createElement('span');
      pill.className='pill';
      pill.innerHTML = `<strong>${name}:</strong> ${df(val)} <span class="muted">(${(rate*100).toFixed(1)}%)</span>`;
      el.appendChild(pill);
    });
  }

  function buildQuality(){
    const q = state.data.delivery_quality;
    const pct = (q.success/(q.success+q.errors))*100;
    document.getElementById('quality').textContent = pct.toFixed(2) + '%';
    document.getElementById('qualityCaption').textContent = `Успешно: ${df(q.success)} • Ошибки: ${df(q.errors)}`;
  }

  function buildSpheres(){
    const t = document.querySelector('#spheresTable tbody');
    t.innerHTML='';
    const avgO = state.data.averages.open_rate;
    const avgR = state.data.averages.reply_rate;
    document.getElementById('avgLine').textContent = `Средние значения по всем сферам: открытия ${(avgO*100).toFixed(1)}% • ответы ${(avgR*100).toFixed(1)}%`;
    state.data.spheres.forEach(s=>{
      const oDelta = (s.open_rate-avgO)/avgO*100;
      const rDelta = (s.reply_rate-avgR)/avgR*100;
      const eff = ((oDelta+rDelta)/2);
      const cls = eff>=0 ? 'up' : 'down';
      const arrow = eff>=0 ? '▲' : '▼';
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${s.name}</td>
        <td>${df(s.sent)}</td>
        <td>${(s.open_rate*100).toFixed(1)}%</td>
        <td>${(s.reply_rate*100).toFixed(1)}%</td>
        <td class="${cls}">${arrow} ${eff.toFixed(1)}%</td>
      `;
      t.appendChild(tr);
    });
  }

  // Tabs
  document.querySelectorAll('.tab').forEach(btn=>{
    btn.addEventListener('click',()=>{
      document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const id = btn.dataset.tab;
      document.querySelectorAll('.tabpane').forEach(p=>p.style.display='none');
      document.getElementById(id).style.display='block';
    });
  });

  loadData();
  </script>
</body>
</html>
